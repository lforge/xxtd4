<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.css">
    <style>
      code { background: none; color: none; border: none; };
      li code { white-space: pre-wrap; margin: 0; padding: 0; border: 0; border-radius: 0; line-height: 18px }
      .covered { background: #cfc; }
      .uncovered { background: #fcc; }
      a, a:visited { color:black; font-size:14pt; }
      pre li .hits {
        float: right;
        margin-left: 10px;
        padding: 2px 4px;
        background: linear-gradient(#222, #666);
        background: -webkit-gradient(linear, 0 0, 0 bottom, from(#222), to(#666));
        background: -moz-linear-gradient(#222, #666);
        background: linear-gradient(#222, #666);
        color: white;
        font-family: Helvetica, "Helvetica Neue", Arial, sans-serif;
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        border-radius: 3px;
        line-height: 10px;
      }

      pre {
        border: none;
        background: none;
      }

      .S{color:red}
      .func{color:blue}
      .C{color:orange}
      .kwrd{font-weight:bold}
      .R{color:gray}

    </style>
    <script>
      function init() {
        var id = location.href.split('#')[1];
        if (id)
          document.getElementById(id).style.display = '';
      }
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row"><div class="span3"><a href="#lib-controller-js" class="filename" name="lib-controller-js" onclick="var el = document.getElementById('lib-controller-js'); el.style.display = el.style.display ? '' : 'none';">lib/controller.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 80%"><strong>80%</strong> [249/838]</div></div></div></div><div id="lib-controller-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> cache = <span class="gly">{</span><span class="gly">}</span>, layoutsCache = <span class="gly">{</span><span class="gly">}</span>, fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    path        = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    <span class="C">// import railway utils</span></code></li><li class=""><code>    utils       = <span class="func">require</span>(<span class="S">'./railway_utils'</span>),</code></li><li class=""><code>    safe_merge  = utils.safe_merge,</code></li><li class=""><code>    camelize    = utils.camelize,</code></li><li class=""><code>    classify    = utils.classify,</code></li><li class=""><code>    underscore  = utils.underscore,</code></li><li class=""><code>    singularize = utils.singularize,</code></li><li class=""><code>    pluralize   = utils.pluralize,</code></li><li class=""><code>    $           = utils.stylize.$,</code></li><li class=""><code>    log         = utils.debug,</code></li><li class="covered"><code>    runCode     = utils.runCode;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">var</span> IS_NODE_04 = process.versions.node < <span class="S">'0.6'</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">var</span> ctlParams = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">var</span> id = 0;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Controller encapsulates http request handling layer. It allows to </span></code></li><li class=""><code><span class="C"> * render response, redirect, and tons of other related stuff.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Instance of controller is actual response handler, it's not a </span></code></li><li class=""><code><span class="C"> * like in RoR, you can not inherit controllers, just load, mix.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Inheritance in controllers is bad idea.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name - name of controller</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Controller</span>(name) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">11</span></li><li class="covered"><code>    this.id = ++id;</code><span class="hits">11</span></li><li class="covered"><code>    this._beforeFilters = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this._afterFilters = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this._actions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this._layout = null;</code><span class="hits">11</span></li><li class="covered"><code>    this._buffer = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class="covered"><code>    ctlParams<span class="gly">[</span>this.id<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class="covered"><code>    this.__dirname = app.root;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!layoutsCache<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// TODO: what if view engine name differs from extension?</span></code></li><li class="covered"><code>        layoutsCache<span class="gly">[</span>name<span class="gly">]</span> = path.<span class="func">existsSync</span>(app.root + <span class="S">'/app/views/layouts/'</span> + name + <span class="S">'_layout.'</span> + app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span>) ? name : <span class="S">'application'</span>;</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.baseLayout =</code></li><li class="covered"><code>    ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.layou = layoutsCache<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// allow to disable layout by default for all views</span></code></li><li class=""><code>    <span class="C">// using app.settings['view options'].layout = false</span></code></li><li class=""><code>    <span class="kwrd">if</span> ((app.<span class="func">set</span>(<span class="S">'view options'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).layout === false) <span class="gly">{</span></code></li><li class="uncovered"><code>        ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.baseLayout = false;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    this.controllerName = name;</code><span class="hits">11</span></li><li class="covered"><code>    this.controllerFile = Controller.index<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.controllerFile) <span class="gly">{</span></code></li><li class="uncovered"><code>        throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Controller '</span> + name + <span class="S">' is not defined'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// import outer context</span></code></li><li class=""><code>    <span class="kwrd">if</span> (Controller.context<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(Controller.context<span class="gly">[</span>name<span class="gly">]</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            self<span class="gly">[</span>key<span class="gly">]</span> = Controller.context<span class="gly">[</span>name<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span>.<span class="func">bind</span>(self);</code><span class="hits">11</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// fix object inheritance broken when using as context</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(Controller.prototype).<span class="func">forEach</span>(<span class="kwrd">function</span> (method) <span class="gly">{</span></code></li><li class="covered"><code>        self<span class="gly">[</span>method<span class="gly">]</span> = Controller.prototype<span class="gly">[</span>method<span class="gly">]</span>.<span class="func">bind</span>(self);</code><span class="hits">319</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">11</span></li><li class=""><code></code></li><li class="covered"><code>    this._filterParams = <span class="gly">[</span><span class="S">'password'</span><span class="gly">]</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!IS_NODE_04) <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'response'</span>,  <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.res <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'res'</span>,       <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.res <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'request'</span>,   <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.req <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'req'</span>,       <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.req <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'session'</span>,   <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.req.session <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'params'</span>,    <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.req.params <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'body'</span>,      <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.req.body <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'next'</span>,      <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.next <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'actionName'</span>,<span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.action <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">__defineGetter__</span>(<span class="S">'path_to'</span>,   <span class="kwrd">function</span> () <span class="gly">{</span> <span class="kwrd">return</span> this.ctx.paths <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    this.t = <span class="func">T</span>();</code><span class="hits">11</span></li><li class="covered"><code>    this.t.locale = app.settings.defaultLocale <span class="gly">|</span><span class="gly">|</span> <span class="S">'en'</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this.T = T;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (global.__cov && !this.__cov) <span class="gly">{</span></code></li><li class="covered"><code>        this.__cov = global.__cov;</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Publish some object or function to use in another controller</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.publish = <span class="kwrd">function</span> (name, obj) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> name === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        obj = name;</code><span class="hits">5</span></li><li class="covered"><code>        this._buffer<span class="gly">[</span>obj.name<span class="gly">]</span> = obj;</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> name === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this._buffer<span class="gly">[</span>name<span class="gly">]</span> = obj;</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Get some object or function published in another controller</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.use = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this._buffer<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Configure which query params should be filtered from logging</span></code></li><li class=""><code><span class="C"> * @param {String} param 1 name</span></code></li><li class=""><code><span class="C"> * @param {String} param 2 name</span></code></li><li class=""><code><span class="C"> * @param ...</span></code></li><li class=""><code><span class="C"> * @param {String} param n name</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.filterParameterLogging = <span class="kwrd">function</span> (args) <span class="gly">{</span></code></li><li class="covered"><code>    this._filterParams = this._filterParams.<span class="func">concat</span>(Array.prototype.slice.<span class="func">call</span>(arguments));</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize controller (called on first request)</span></code></li><li class=""><code><span class="C"> * @private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype._init = <span class="kwrd">function</span> <span class="func">initializeController</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// reset scope variables</span></code></li><li class="covered"><code>    this._actions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this._beforeFilters = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this._afterFilters = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this._buffer = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class="covered"><code>    ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.layout = ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.baseLayout;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// publish models</span></code></li><li class=""><code>    <span class="kwrd">if</span> (app.models) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(app.models).<span class="func">forEach</span>(<span class="kwrd">function</span> (className) <span class="gly">{</span></code></li><li class="uncovered"><code>            this<span class="gly">[</span>className<span class="gly">]</span> = app.models<span class="gly">[</span>className<span class="gly">]</span>;</code></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">runCode</span>(this.controllerFile, this);</code><span class="hits">11</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @param {String} name - name of filter to skip</span></code></li><li class=""><code><span class="C"> * @param {Array} or {String} only - choose actions to skip filter</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.skipBeforeFilter = <span class="kwrd">function</span> (name, only) <span class="gly">{</span></code></li><li class=""><code>    this._beforeFilters.<span class="func">forEach</span>(<span class="kwrd">function</span> (filter, i) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter<span class="gly">[</span>0<span class="gly">]</span> && filter<span class="gly">[</span>0<span class="gly">]</span>.customName && name === filter<span class="gly">[</span>0<span class="gly">]</span>.customName) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">skipFilter</span>(this._beforeFilters, i, only ? only.only : null);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @param {String} name - name of filter to skip</span></code></li><li class=""><code><span class="C"> * @param {Array} or {String} only - choose actions to skip filter</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.skipAfterFilter = <span class="kwrd">function</span> (name, only) <span class="gly">{</span></code></li><li class=""><code>    this._afterFilters.<span class="func">forEach</span>(<span class="kwrd">function</span> (filter, i) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter<span class="gly">[</span>0<span class="gly">]</span> && filter<span class="gly">[</span>0<span class="gly">]</span>.customName && name === filter<span class="gly">[</span>0<span class="gly">]</span>.customName) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">skipFilter</span>(this._afterFilters, i, only ? only.only : null);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @param {Array} filters collection</span></code></li><li class=""><code><span class="C"> * @param {Number} index of filter to skip</span></code></li><li class=""><code><span class="C"> * @param {Array} or {String} only - choose actions to skip filter</span></code></li><li class=""><code><span class="C"> * @private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">skipFilter</span>(filters, index, only) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!only) <span class="gly">{</span></code></li><li class="covered"><code>        delete filters<span class="gly">[</span>index<span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>0<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span> = <span class="gly">{</span>except: <span class="gly">[</span><span class="gly">]</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except) <span class="gly">{</span></code></li><li class="uncovered"><code>            filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except = <span class="gly">[</span>filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> only === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except.<span class="func">push</span>(only);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (only && only.constructor.name === <span class="S">'Array'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            console.<span class="func">log</span>(<span class="S">'aaaaaaa'</span>);</code><span class="hits">2</span></li><li class=""><code>            only.<span class="func">forEach</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="covered"><code>                filters<span class="gly">[</span>index<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>.except.<span class="func">push</span>(name);</code><span class="hits">2</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define controller action</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param name String - optional (if missed, named function required as first param)</span></code></li><li class=""><code><span class="C"> * @param action Funcion - required, should be named function if first arg missed</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action(function index() {</span></code></li><li class=""><code><span class="C"> *     Post.all(function (err, posts) {</span></code></li><li class=""><code><span class="C"> *         render({posts: posts});</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.action = <span class="kwrd">function</span> (name, action) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> name === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        action = name;</code><span class="hits">14</span></li><li class="covered"><code>        name = action.name;</code><span class="hits">14</span></li><li class=""><code>        <span class="kwrd">if</span> (!name) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Named function required when `name` param omitted'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    action.isAction = true;</code><span class="hits">16</span></li><li class="covered"><code>    action.customName = name;</code><span class="hits">16</span></li><li class="covered"><code>    this._actions<span class="gly">[</span>name<span class="gly">]</span> = action;</code><span class="hits">16</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Internal request handler. Serves request using railway env:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - update context links: req, res, next and other req-sensitive stuff</span></code></li><li class=""><code><span class="C"> * - run before filters</span></code></li><li class=""><code><span class="C"> * - run action</span></code></li><li class=""><code><span class="C"> * - run after filters</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * `perform` method called by `ControllerBridge`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} actionName</span></code></li><li class=""><code><span class="C"> * @param {IncomingMessage} req - incoming http request</span></code></li><li class=""><code><span class="C"> * @param {ServerResponse} res - http server response</span></code></li><li class=""><code><span class="C"> * @private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.perform = <span class="kwrd">function</span> (actionName, req, res, nextRoute) <span class="gly">{</span></code></li><li class=""><code>    res.info = <span class="gly">{</span></code></li><li class=""><code>        controller: this.controllerName,</code></li><li class=""><code>        action: actionName,</code></li><li class=""><code>        startTime: Date.<span class="func">now</span>()</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">12</span></li><li class="covered"><code>    res.actionHistory = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">12</span></li><li class=""><code>    <span class="kwrd">if</span> (!this.initialized) <span class="gly">{</span></code></li><li class="covered"><code>        this.initialized = true;</code><span class="hits">5</span></li><li class=""><code>        <span class="kwrd">if</span> (IS_NODE_04) <span class="gly">{</span></code></li><li class="uncovered"><code>            this.actionName = actionName;</code></li><li class="uncovered"><code>            this.request = this.req = req;</code></li><li class="uncovered"><code>            this.request.sandbox = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>            this.response = this.res = res;</code></li><li class="uncovered"><code>            this.params = req.params;</code></li><li class="uncovered"><code>            this.session = res.session;</code></li><li class="uncovered"><code>            this.body = req.body;</code></li><li class="uncovered"><code>            this.next = next;</code></li><li class="uncovered"><code>            this.path_to = Controller.<span class="func">getPathTo</span>(actionName);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        this.<span class="func">_init</span>();</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> ctl = this, timeStart = false, prevMethod;</code><span class="hits">12</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// need to track uniqueness of filters by name</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> queueIndex = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">12</span></li><li class=""><code></code></li><li class=""><code>    this.ctx = <span class="gly">{</span></code></li><li class=""><code>        req: req,</code></li><li class=""><code>        res: res,</code></li><li class=""><code>        next: next,</code></li><li class=""><code>        action: actionName,</code></li><li class=""><code>        paths: Controller.<span class="func">getPathTo</span>(actionName)</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">12</span></li><li class=""><code></code></li><li class="covered"><code>    req.sandbox = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">12</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">log</span>(<span class="S">''</span>);</code><span class="hits">12</span></li><li class="covered"><code>    <span class="func">log</span>(<span class="func">$</span>((<span class="kwrd">new</span> Date).<span class="func">toString</span>()).yellow + <span class="S">' '</span> + <span class="func">$</span>(this.id).bold);</code><span class="hits">12</span></li><li class="covered"><code>    <span class="func">log</span>(<span class="func">$</span>(req.method).bold, <span class="func">$</span>(req.url).grey, <span class="S">'controller:'</span>, <span class="func">$</span>(this.controllerName).green, <span class="S">'action:'</span>, <span class="func">$</span>(this.actionName).blue);</code><span class="hits">12</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (req.query && Object.<span class="func">keys</span>(req.query).length) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">log</span>(<span class="func">$</span>(<span class="S">'Query: '</span>).bold + JSON.<span class="func">stringify</span>(req.query));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (req.body && req.method !== <span class="S">'GET'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> filteredBody = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code>        Object.<span class="func">keys</span>(req.body).<span class="func">forEach</span>(<span class="kwrd">function</span> (param) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!ctl._filterParams.<span class="func">some</span>(<span class="kwrd">function</span> (filter) <span class="gly">{</span><span class="kwrd">return</span> param.<span class="func">search</span>(filter) !== -1;<span class="gly">}</span>)) <span class="gly">{</span></code></li><li class="covered"><code>                filteredBody<span class="gly">[</span>param<span class="gly">]</span> = req.body<span class="gly">[</span>param<span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                filteredBody<span class="gly">[</span>param<span class="gly">]</span> = <span class="S">'[FILTERED]'</span>;</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="func">log</span>(<span class="func">$</span>(<span class="S">'Body:  '</span>).bold + JSON.<span class="func">stringify</span>(filteredBody));</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// build queue using before-, after- filters and action</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> queue = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">12</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">enqueue</span>(this._beforeFilters, queue);</code><span class="hits">12</span></li><li class="covered"><code>    queue.<span class="func">push</span>(<span class="func">getCaller</span>(this._actions<span class="gly">[</span>actionName<span class="gly">]</span>));</code><span class="hits">12</span></li><li class="covered"><code>    <span class="func">enqueue</span>(this._afterFilters, queue);</code><span class="hits">12</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'model cache'</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// queue.push(getCaller(app.disconnectSchemas));</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (app.<span class="func">enabled</span>(<span class="S">'eval cache'</span>)) <span class="gly">{</span></code></li><li class=""><code>        queue.<span class="func">push</span>(<span class="func">getCaller</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">backToPool</span>(ctl);</code></li><li class="uncovered"><code>        <span class="gly">}</span>));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// start serving request</span></code></li><li class="covered"><code>    <span class="func">next</span>();</code><span class="hits">12</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> logActions = app.<span class="func">enabled</span>(<span class="S">'log actions'</span>);</code><span class="hits">12</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">next</span>(err) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (logActions && timeStart && prevMethod) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">log</span>(<span class="S">'<<< '</span> + prevMethod.customName + <span class="S">' ['</span> + (Date.<span class="func">now</span>() - timeStart) + <span class="S">' ms]'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (err && err.constructor.name === <span class="S">'Error'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="func">nextRoute</span>(err);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (timeStart && prevMethod) <span class="gly">{</span></code></li><li class="covered"><code>            res.actionHistory.<span class="func">push</span>(<span class="gly">{</span>name: prevMethod.customName, time: Date.<span class="func">now</span>() - timeStart<span class="gly">}</span>);</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// run next method in queue (if any callable method)</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> method = queue.<span class="func">shift</span>();</code><span class="hits">29</span></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> method == <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class=""><code>            process.<span class="func">nextTick</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                method.<span class="func">call</span>(ctl.request.sandbox, next);</code><span class="hits">27</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">27</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            res.info.appTime = Date.<span class="func">now</span>() - res.info.startTime;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">getCaller</span>(method) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!method) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Undefined action'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="kwrd">function</span> (next) <span class="gly">{</span></code><span class="hits">29</span></li><li class="covered"><code>            req.inAction = method.isAction;</code><span class="hits">27</span></li><li class=""><code>            <span class="kwrd">if</span> (logActions && method.customName) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (method.isAction) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">log</span>(<span class="S">'>>> perform '</span> + <span class="func">$</span>(method.customName).bold.blue);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">log</span>(<span class="S">'>>> perform '</span> + <span class="func">$</span>(method.customName).bold.grey);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            timeStart = Date.<span class="func">now</span>();</code><span class="hits">27</span></li><li class="covered"><code>            prevMethod = method;</code><span class="hits">27</span></li><li class="covered"><code>            method.<span class="func">call</span>(this, next);</code><span class="hits">27</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">enqueue</span>(collection, queue) <span class="gly">{</span></code></li><li class=""><code>        collection.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> params = f<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">26</span></li><li class=""><code>            <span class="kwrd">if</span> (!params) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">enqueue</span>();</code><span class="hits">6</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (params.only && params.only.<span class="func">indexOf</span>(actionName) !== -1 && (!params.except <span class="gly">|</span><span class="gly">|</span> params.except.<span class="func">indexOf</span>(actionName) === -1)) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">enqueue</span>();</code><span class="hits">3</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (params.except && params.except.<span class="func">indexOf</span>(actionName) === -1) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">enqueue</span>();</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">function</span> <span class="func">enqueue</span>() <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (f<span class="gly">[</span>2<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">if</span> (queueIndex<span class="gly">[</span>f<span class="gly">[</span>2<span class="gly">]</span><span class="gly">]</span>) <span class="kwrd">return</span>;</code><span class="hits">16</span></li><li class="covered"><code>                    queueIndex<span class="gly">[</span>f<span class="gly">[</span>2<span class="gly">]</span><span class="gly">]</span> = true;</code><span class="hits">16</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                queue.<span class="func">push</span>(<span class="func">getCaller</span>(f<span class="gly">[</span>0<span class="gly">]</span>));</code><span class="hits">17</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">24</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Layout setter/getter</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - when called without arguments, used as getter,</span></code></li><li class=""><code><span class="C"> * - when called with string, used as setter</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * When `layout` not called controller trying to get guess which layout to use.</span></code></li><li class=""><code><span class="C"> * First of all controller looking for layout with the same name as controller,</span></code></li><li class=""><code><span class="C"> * for example `users_controller` will choose `users_laout`, if there's no </span></code></li><li class=""><code><span class="C"> * layout with this name, controller using `application_layout`.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * If you do not want to use any layout by default, you can just set it up:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     app.set('view options', {layout: false});</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * this will prevent you from repeating `layout(false)` in each controller where</span></code></li><li class=""><code><span class="C"> * you do not want to use layout, for example in api controllers.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - choose </span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} layout - [optional] layout name</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.layout = <span class="kwrd">function</span> <span class="func">layout</span>(l) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> l !== <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.layout = l;</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.layout ? ctlParams<span class="gly">[</span>this.id<span class="gly">]</span>.layout + <span class="S">'_layout'</span> : null;</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">filter</span>(args) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>0<span class="gly">]</span> === <span class="S">'string'</span> && <span class="kwrd">typeof</span> args<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// change order</span></code></li><li class="uncovered"><code>        args<span class="gly">[</span>1<span class="gly">]</span>.customName = args<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="gly">[</span>args<span class="gly">[</span>1<span class="gly">]</span>, args<span class="gly">[</span>2<span class="gly">]</span>, args<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// normal order</span></code></li><li class="covered"><code>        args<span class="gly">[</span>0<span class="gly">]</span>.customName = args<span class="gly">[</span>0<span class="gly">]</span>.name;</code><span class="hits">19</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="gly">[</span>args<span class="gly">[</span>0<span class="gly">]</span>, args<span class="gly">[</span>1<span class="gly">]</span>, args<span class="gly">[</span>0<span class="gly">]</span>.name<span class="gly">]</span>;</code><span class="hits">19</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Schedule before filter to the end of queue. This method can be called</span></code></li><li class=""><code><span class="C"> * with named function as single param, or with two params: name and </span></code></li><li class=""><code><span class="C"> * anonimous function</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Examples:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * before('some named filter', function () {});</span></code></li><li class=""><code><span class="C"> * before(function namedMethod() {});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This filters can be skipped using this names in future. Examples:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * skipBeforeFilter('some named filter');</span></code></li><li class=""><code><span class="C"> * skipBeforeFilter('namedMethod');</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Please note, that every named filter only can be scheduled once:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * before(function myMethod() {</span></code></li><li class=""><code><span class="C"> *     // some code</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * before(function myMethod() {</span></code></li><li class=""><code><span class="C"> *     // another code</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * This will only schedule first method!</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @alias beforeFilter</span></code></li><li class=""><code><span class="C"> * @param {Funcion} f</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.before = <span class="kwrd">function</span> <span class="func">before</span>(f, params) <span class="gly">{</span></code></li><li class="covered"><code>    this._beforeFilters.<span class="func">push</span>(<span class="func">filter</span>(arguments));</code><span class="hits">19</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>Controller.prototype.beforeFilter = Controller.prototype.before;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Schedule before filter to the start of queue. This method can be called</span></code></li><li class=""><code><span class="C"> * with named function as single param, or with two params: name and </span></code></li><li class=""><code><span class="C"> * anonimous function.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @alias prependBeforeFilter</span></code></li><li class=""><code><span class="C"> * @param {Funcion} f</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.prependBefore = <span class="kwrd">function</span> <span class="func">prependBefore</span>(f, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    this._beforeFilters.<span class="func">unshift</span>(<span class="func">filter</span>(arguments));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>Controller.prototype.prependBeforeFilter = Controller.prototype.prependBefore;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @override default controller string representation</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.toString = <span class="kwrd">function</span> <span class="func">toString</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'Controller '</span> + this.controllerName;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @param {String} name - name of action</span></code></li><li class=""><code><span class="C"> * @returns whether controller responds to action</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.respondTo = <span class="kwrd">function</span> <span class="func">respondTo</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="kwrd">typeof</span> this._actions<span class="gly">[</span>name<span class="gly">]</span> == <span class="S">'function'</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Append after filter to the end of queue. This method can be called</span></code></li><li class=""><code><span class="C"> * with named function as single param, or with two params: name and </span></code></li><li class=""><code><span class="C"> * anonimous function.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} f</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.after = <span class="kwrd">function</span> <span class="func">after</span>(f, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    this._afterFilters.<span class="func">push</span>(<span class="func">filter</span>(arguments));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>Controller.prototype.afterFilter = Controller.prototype.after;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Prepend after filter to the start of queue. This method can be called</span></code></li><li class=""><code><span class="C"> * with named function as single param, or with two params: name and </span></code></li><li class=""><code><span class="C"> * anonimous function.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} f</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.prependAfter = <span class="kwrd">function</span> <span class="func">prependAfter</span>(f, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    this._afterFilters.<span class="func">unshift</span>(<span class="func">filter</span>(arguments));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>Controller.prototype.prependAfterFilter = Controller.prototype.prependAfter;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Set current locale. This setting will affect all views locale-specific helpers.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param locale</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.setLocale = <span class="kwrd">function</span> (locale) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.t.locale = T.<span class="func">localeSupported</span>(locale) ? locale : app.settings.defaultLocale;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Get current locale</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @returns {String} locale name</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.getLocale = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.t.locale;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Load another controller code in this context</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} controller - name of controller (without _controller suffix)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.load = <span class="kwrd">function</span> (controller) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ctl = Controller.index<span class="gly">[</span>controller<span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (!ctl) <span class="gly">{</span></code></li><li class="uncovered"><code>        throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Controller '</span> + controller + <span class="S">' is not defined. Please note that namespaced controllers names should include namespace when loading'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="func">runCode</span>(ctl, this);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Send response, as described in ExpressJS guide:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This method is a high level response utility allowing you</span></code></li><li class=""><code><span class="C"> * to pass objects to respond with json, strings for html,</span></code></li><li class=""><code><span class="C"> * Buffer instances, or numbers representing the status code.</span></code></li><li class=""><code><span class="C"> * The following are all valid uses:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * send(); // 204</span></code></li><li class=""><code><span class="C"> * send(new Buffer('wahoo'));</span></code></li><li class=""><code><span class="C"> * send({ some: 'json' });</span></code></li><li class=""><code><span class="C"> * send('&lt;p>some html&lt;/p>');</span></code></li><li class=""><code><span class="C"> * send('Sorry, cant find that', 404);</span></code></li><li class=""><code><span class="C"> * send('text', { 'Content-Type': 'text/plain' }, 201);</span></code></li><li class=""><code><span class="C"> * send(404);</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.send = <span class="kwrd">function</span> (x) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">log</span>(<span class="S">'Send to client: '</span> + x);</code><span class="hits">1</span></li><li class="covered"><code>    this.response.send.<span class="func">apply</span>(this.response, Array.prototype.slice.<span class="func">call</span>(arguments));</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">if</span> (this.request.inAction) this.<span class="func">next</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Set or get response header</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} key - name of header</span></code></li><li class=""><code><span class="C"> * @param {String} val - value of header (optional)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * When second argument is omitted method acts as getter.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * res.header('Content-Length');</span></code></li><li class=""><code><span class="C"> * // => undefined</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * res.header('Content-Length', 123);</span></code></li><li class=""><code><span class="C"> * // => 123</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * res.header('Content-Length');</span></code></li><li class=""><code><span class="C"> * // => 123</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.header = <span class="kwrd">function</span> (key, val) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.response.header.<span class="func">call</span>(this.response, key, val);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Redirect to `path`</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.redirect = <span class="kwrd">function</span> (path) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="func">log</span>(<span class="S">'Redirected to'</span>, <span class="func">$</span>(path).grey);</code></li><li class="uncovered"><code>    this.response.<span class="func">redirect</span>(path.<span class="func">toString</span>());</code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (this.request.inAction) this.<span class="func">next</span>();</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Render response.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} view name [optional]</span></code></li><li class=""><code><span class="C"> * @param {Object} locals - data passed to view as local variables [optional]</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * When first parameter is omitted action name used as view name:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action(function index() {</span></code></li><li class=""><code><span class="C"> *     render(); // will render 'index' action of current controller</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Second argument is optional too, you can set local variables using `this` inside</span></code></li><li class=""><code><span class="C"> * action:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action('new', function () {</span></code></li><li class=""><code><span class="C"> *     this.title = 'Create new post';</span></code></li><li class=""><code><span class="C"> *     this.post = new Post;</span></code></li><li class=""><code><span class="C"> *     render();</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * will result the same as</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action('new', function () {</span></code></li><li class=""><code><span class="C"> *     render({</span></code></li><li class=""><code><span class="C"> *         title: 'Create new post',</span></code></li><li class=""><code><span class="C"> *         post: new Post</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.render = <span class="kwrd">function</span> (arg1, arg2) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> view, params;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> arg1 == <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        view = arg1;</code></li><li class="uncovered"><code>        params = arg2;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        view = this.actionName;</code><span class="hits">2</span></li><li class="covered"><code>        params = arg1;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    params.controllerName = params.controllerName <span class="gly">|</span><span class="gly">|</span> this.controllerName;</code><span class="hits">2</span></li><li class="covered"><code>    params.actionName = params.actionName <span class="gly">|</span><span class="gly">|</span> this.actionName;</code><span class="hits">2</span></li><li class="covered"><code>    params.path_to = this.path_to;</code><span class="hits">2</span></li><li class="covered"><code>    params.request = this.request;</code><span class="hits">2</span></li><li class="covered"><code>    params.params = this.request.params;</code><span class="hits">2</span></li><li class="covered"><code>    params.t = this.t;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">var</span> layout = this.<span class="func">layout</span>(),</code></li><li class="covered"><code>        file = this.controllerName + <span class="S">'/'</span> + view;</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (this.response.renderCalled) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">log</span>(<span class="S">'Rendering'</span>, <span class="func">$</span>(file).grey, <span class="S">'using layout'</span>, <span class="func">$</span>(layout).grey, <span class="S">'called twice.'</span>, <span class="func">$</span>(<span class="S">'render() can be called only once!'</span>).red);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> helper;</code><span class="hits">2</span></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="uncovered"><code>        helper = <span class="func">require</span>(app.root + <span class="S">'/app/helpers/'</span> + this.controllerName + <span class="S">'_helper'</span>);</code></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="covered"><code>        helper = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> appHelper;</code><span class="hits">2</span></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="uncovered"><code>        appHelper = <span class="func">require</span>(app.root + <span class="S">'/app/helpers/application_helper'</span>);</code></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="covered"><code>        appHelper = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">log</span>(<span class="S">'Rendering'</span>, <span class="func">$</span>(file).grey, <span class="S">'using layout'</span>, <span class="func">$</span>(layout).grey);</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> helpers = railway.helpers.<span class="func">personalize</span>(this);</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    this.response.renderCalled = true;</code><span class="hits">2</span></li><li class=""><code>    this.response.<span class="func">render</span>(file, <span class="gly">{</span></code></li><li class=""><code>        locals: <span class="func">safe_merge</span>(params, this.request.sandbox, this.path_to, helpers, helpers.__proto__, helper, appHelper),</code></li><li class=""><code>        layout: layout ? <span class="S">'layouts/'</span> + layout : false,</code></li><li class=""><code>        debug:  false</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">if</span> (this.request.inAction) this.<span class="func">next</span>();</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add flash error to display in next request</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} type</span></code></li><li class=""><code><span class="C"> * @param {String} message</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.flash = <span class="kwrd">function</span> (type, message) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.request.flash.<span class="func">apply</span>(this.request, Array.prototype.slice.<span class="func">call</span>(arguments));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">var</span> pool = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="kwrd">function</span> <span class="func">backToPool</span>(ctl) <span class="gly">{</span></code></li><li class="uncovered"><code>    pool<span class="gly">[</span>ctl.controllerName<span class="gly">]</span>.<span class="func">push</span>(ctl);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code>exports.load = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'eval cache'</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">Controller</span>(name);</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (!pool<span class="gly">[</span>name<span class="gly">]</span>) pool<span class="gly">[</span>name<span class="gly">]</span> = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ctl = pool<span class="gly">[</span>name<span class="gly">]</span>.<span class="func">shift</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (!ctl) <span class="gly">{</span></code></li><li class="uncovered"><code>            ctl = <span class="kwrd">new</span> <span class="func">Controller</span>(name);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> ctl;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.loadAll = <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">getOwnPropertyNames</span>(Controller.index).<span class="func">forEach</span>(<span class="kwrd">function</span>(c) <span class="gly">{</span></code></li><li class="covered"><code>        exports.<span class="func">load</span>(c).<span class="func">_init</span>();</code><span class="hits">6</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.getPathTo = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> railway.routeMapper.pathTo;</code><span class="hits">12</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add custom base controller dir to railway pool. It allows you to build</span></code></li><li class=""><code><span class="C"> * extensions with your own controllers, and build app</span></code></li><li class=""><code><span class="C"> * breaken by modules</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} basePath</span></code></li><li class=""><code><span class="C"> * @param {String} prefix</span></code></li><li class=""><code><span class="C"> * @param {Object} context - controller context tweaks, all members of</span></code></li><li class=""><code><span class="C"> * this object will be accesible in controller</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @public railway.controller.addBasePath</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addBasePath</span>(basePath, prefix, context) <span class="gly">{</span></code></li><li class="covered"><code>    prefix = prefix <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(basePath)) <span class="gly">{</span></code></li><li class=""><code>        fs.<span class="func">readdirSync</span>(basePath).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> stat = fs.<span class="func">statSync</span>(path.jo<span class="kwrd">in</span>(basePath, file));</code><span class="hits">6</span></li><li class=""><code>            <span class="kwrd">if</span> (stat.<span class="func">isFile</span>()) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> m = file.<span class="func">match</span>(<span class="R">/(.*?)_controller\.(js|coffee)$/</span>);</code><span class="hits">6</span></li><li class=""><code>                <span class="kwrd">if</span> (m) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">var</span> ctl = prefix + m<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">6</span></li><li class="covered"><code>                    Controller.index<span class="gly">[</span>ctl<span class="gly">]</span> = Controller.index<span class="gly">[</span>ctl<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> path.jo<span class="kwrd">in</span>(basePath, file);</code><span class="hits">6</span></li><li class="covered"><code>                    Controller.context<span class="gly">[</span>ctl<span class="gly">]</span> = Controller.context<span class="gly">[</span>ctl<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> context;</code><span class="hits">6</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (stat.<span class="func">isDirectory</span>()) <span class="gly">{</span></code></li><li class="uncovered"><code>                exports.<span class="func">addBasePath</span>(path.jo<span class="kwrd">in</span>(basePath, file), prefix + file + <span class="S">'/'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>exports.addBasePath = addBasePath;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.Controller = Controller;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    Controller.index = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    Controller.context = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    exports.<span class="func">addBasePath</span>(app.root + <span class="S">'/app/controllers'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Enables CSRF Protection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This filter will check `authenticity_token` param of POST request </span></code></li><li class=""><code><span class="C"> * and compare with token calculated by session token and app-wide secret</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} secret</span></code></li><li class=""><code><span class="C"> * @param {String} paramName</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example `app/controllers/application_controller.js`</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * before('protect from forgery', function () {</span></code></li><li class=""><code><span class="C"> *     protectFromForgery('415858f8c3f63ba98546437f03b5a9a4ddea301f');</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.prototype.protectFromForgery = <span class="kwrd">function</span> <span class="func">protectFromForgery</span>(secret, paramName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> req = this.request;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!req.session) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> this.<span class="func">next</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!req.session.csrfToken) <span class="gly">{</span></code></li><li class="covered"><code>        req.session.csrfToken = Math.<span class="func">random</span>();</code><span class="hits">1</span></li><li class="covered"><code>        req.csrfParam = paramName <span class="gly">|</span><span class="gly">|</span> <span class="S">'authenticity_token'</span>;</code><span class="hits">1</span></li><li class="covered"><code>        req.csrfToken = <span class="func">sign</span>(req.session.csrfToken);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">return</span> this.<span class="func">next</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// publish secure credentials</span></code></li><li class="covered"><code>    req.csrfParam = paramName <span class="gly">|</span><span class="gly">|</span> <span class="S">'authenticity_token'</span>;</code><span class="hits">3</span></li><li class="covered"><code>    req.csrfToken = <span class="func">sign</span>(req.session.csrfToken);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (req.originalMethod == <span class="S">'POST'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> token = req.<span class="func">param</span>(<span class="S">'authenticity_token'</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">if</span> (!token <span class="gly">|</span><span class="gly">|</span> token !== <span class="func">sign</span>(req.session.csrfToken)) <span class="gly">{</span></code></li><li class="covered"><code>            railway.logger.<span class="func">write</span>(<span class="S">'Incorrect authenticity token'</span>);</code><span class="hits">1</span></li><li class="covered"><code>            this.<span class="func">send</span>(403);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            this.<span class="func">next</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">next</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">sign</span>(n) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(<span class="S">'crypto'</span>).<span class="func">createHash</span>(<span class="S">'sha1'</span>).<span class="func">update</span>(n.<span class="func">toString</span>()).<span class="func">update</span>(secret.<span class="func">toString</span>()).<span class="func">digest</span>(<span class="S">'hex'</span>);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Controller.prototype.protectedFromForgery = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.request.csrfToken && this.request.csrfParam;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-generators-js" class="filename" name="lib-generators-js" onclick="var el = document.getElementById('lib-generators-js'); el.style.display = el.style.display ? '' : 'none';">lib/generators.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 10%"><strong>10%</strong> [233/661]</div></div></div></div><div id="lib-generators-js" style="display:none;"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> path      = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> fs        = <span class="func">require</span>(<span class="S">'fs'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> sys = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Shortcut required railway utils</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> pluralize = railway.utils.pluralize;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> camelize  = railway.utils.camelize;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> $         = railway.utils.stylize.$;</code><span class="hits">1</span></li><li class=""><code><span class="kwrd">var</span> exec      = <span class="func">require</span>(<span class="S">'child_process'</span>).exec</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Command line options</span></code></li><li class=""><code><span class="C"> * populated by parseOptions method</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @api private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> options   = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Generators collection hash</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @type Hash</span></code></li><li class=""><code><span class="C"> * @api private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> collection = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add generator to collection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param name</span></code></li><li class=""><code><span class="C"> * @param callback</span></code></li><li class=""><code><span class="C"> * @param meta Object {description: String, examples: [String]}</span></code></li><li class=""><code><span class="C"> * @api public</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addGenerator</span>(name, callback, meta) <span class="gly">{</span></code></li><li class="covered"><code>    meta = meta <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">5</span></li><li class="covered"><code>    callback.meta = meta;</code><span class="hits">5</span></li><li class="covered"><code>    collection<span class="gly">[</span>name<span class="gly">]</span> = callback;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (meta.alias) <span class="gly">{</span></code></li><li class="covered"><code>        collection<span class="gly">[</span>meta.alias<span class="gly">]</span> = callback;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.addGenerator = addGenerator;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether generator exists</span></code></li><li class=""><code><span class="C"> * @param name - name of generator</span></code></li><li class=""><code><span class="C"> * @api public</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">exists</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> !!collection<span class="gly">[</span>name<span class="gly">]</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.exists = exists;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Call generator method</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">perform</span>(name, args) <span class="gly">{</span></code></li><li class="uncovered"><code>    collection<span class="gly">[</span>name<span class="gly">]</span>(args);</code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.perform = perform;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.list = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> Object.<span class="func">keys</span>(collection).jo<span class="kwrd">in</span>(<span class="S">' '</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add built-in generators</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'init'</span>, initGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'model'</span>, modelGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'controller'</span>, controllerGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'features'</span>, featuresGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'crud'</span>, crudGenerator, <span class="gly">{</span>alias: <span class="S">'scaffold'</span><span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Application initialization generator. Can be called with leading</span></code></li><li class=""><code><span class="C">     * appname param, or without it (init in current dir).</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * When destination</span></code></li><li class=""><code><span class="C">     * is not empty old files wouldn't be overwritten by this generator, it's safe</span></code></li><li class=""><code><span class="C">     * to call generator again and again to restore some non-existing files</span></code></li><li class=""><code><span class="C">     * initial state</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">initGenerator</span>(args) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">parseOptions</span>(<span class="S">'appname'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="gly">[</span> <span class="S">'app/'</span>,</code></li><li class=""><code>          <span class="S">'app/models/'</span>,</code></li><li class=""><code>          <span class="S">'app/controllers/'</span>,</code></li><li class=""><code>          <span class="S">'app/observers/'</span>,</code></li><li class=""><code>          <span class="S">'app/helpers/'</span>,</code></li><li class=""><code>          <span class="S">'app/views/'</span>,</code></li><li class=""><code>          <span class="S">'app/views/layouts/'</span>,</code></li><li class=""><code>          <span class="S">'db/'</span>,</code></li><li class=""><code>          <span class="S">'db/seeds/'</span>,</code></li><li class=""><code>          <span class="S">'db/seeds/development/'</span>,</code></li><li class=""><code>          <span class="S">'log/'</span>,</code></li><li class=""><code>          <span class="S">'public/'</span>,</code></li><li class=""><code>          <span class="S">'public/images'</span>,</code></li><li class=""><code>          <span class="S">'public/stylesheets/'</span>,</code></li><li class=""><code>          <span class="S">'public/javascripts/'</span>,</code></li><li class=""><code>          <span class="S">'node_modules/'</span>,</code></li><li class=""><code>          <span class="S">'config/'</span>,</code></li><li class=""><code>          <span class="S">'config/locales/'</span>,</code></li><li class=""><code>          <span class="S">'config/initializers/'</span>,</code></li><li class=""><code>          <span class="S">'config/environments/'</span></code></li><li class="uncovered"><code>        <span class="gly">]</span>.<span class="func">forEach</span>(createDir);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (options.stylus) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">createDir</span>(<span class="S">'app/assets/'</span>);</code></li><li class="uncovered"><code>            <span class="func">createDir</span>(<span class="S">'app/assets/styles/'</span>);</code></li><li class="uncovered"><code>            <span class="func">createFileByTemplate</span>(<span class="S">'app/assets/styles/example.styl'</span>, <span class="S">'example.styl'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> db = options.db;</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/initializers/db-tools.js'</span>, <span class="S">'db-tools.js'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/routes.js'</span>, <span class="S">'config/routes.js'</span>);</code></li><li class=""><code>        <span class="C">// createFileByTemplate('config/requirements.json', 'requirements.json');</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> srv = <span class="func">createFileByTemplate</span>(<span class="S">'server'</span>, <span class="S">'server'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> secret = <span class="func">require</span>(<span class="S">'crypto'</span>).<span class="func">createHash</span>(<span class="S">'sha1'</span>).<span class="func">update</span>(Math.<span class="func">random</span>().<span class="func">toString</span>()).<span class="func">digest</span>(<span class="S">'hex'</span>);</code></li><li class=""><code>        <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">createFile</span>(<span class="S">'app/controllers/application_controller.coffee'</span>, <span class="S">'before \'protect from forgery\', ->\n    protectFromForgery \''</span> + secret + <span class="S">'\'\n\n'</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">createFile</span>(<span class="S">'app/controllers/application_controller.js'</span>, <span class="S">'before(\'protect from forgery\', function () {\n    protectFromForgery(\''</span> + secret + <span class="S">'\');\n});\n'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environment'</span>,              <span class="S">'config/environment'</span>, <span class="gly">[</span> replaceViewEngine, replacePrependMiddleware <span class="gly">]</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environments/test'</span>,        <span class="S">'config/environments/test'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environments/development'</span>, <span class="S">'config/environments/development'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environments/production'</span>,  <span class="S">'config/environments/production'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/database.json'</span>,            <span class="S">'config/database_'</span> + db + <span class="S">'.json'</span>, replaceAppname);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'db/schema'</span>, <span class="S">'schema'</span>);</code></li><li class="uncovered"><code>        <span class="func">createViewByTemplate</span>(<span class="S">'app/views/layouts/application_layout'</span>, <span class="S">'application_layout'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/index.html'</span>, <span class="S">'index.html'</span>);</code></li><li class=""><code>        </code></li><li class=""><code>        <span class="C">// bootstrap files</span></code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/stylesheets/bootstrap-responsive.css'</span>, <span class="S">'bootstrap-responsive.css'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/stylesheets/bootstrap.css'</span>, <span class="S">'bootstrap.css'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/images/glyphicons-halflings-white.png'</span>, <span class="S">'glyphicons-halflings-white.png'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/images/glyphicons-halflings.png'</span>, <span class="S">'glyphicons-halflings.png'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/javascripts/bootstrap.js'</span>, <span class="S">'bootstrap.js'</span>);</code></li><li class=""><code>        </code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/stylesheets/style.css'</span>, <span class="S">'style.css'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/javascripts/rails.js'</span>, <span class="S">'rails.js'</span>);</code></li><li class=""><code>        <span class="func">createFile</span>(<span class="S">'public/javascripts/application.js'</span>, <span class="S">'~~~C23~~~</span></code></li><li class=""><code><span class="S">        createFileByTemplate('</span>npmfile<span class="S">', '</span>npmfile<span class="S">', replaceViewEngine);</span></code></li><li class=""><code><span class="S">        createFileByTemplate('</span>public/favicon.ico<span class="S">', '</span>favicon.ico<span class="S">');</span></code></li><li class=""><code><span class="S">        var fileExtension = options.coffee ? '</span>.coffee<span class="S">' : '</span>.js<span class="S">';</span></code></li><li class=""><code><span class="S">        var engine = options.coffee ? '</span>coffee<span class="S">' : '</span>node<span class="S">';</span></code></li><li class=""><code><span class="S">        ~~~C24~~~</span></code></li><li class=""><code><span class="S">        ~~~C25~~~</span></code></li><li class=""><code><span class="S">        createFile('</span>Procfile<span class="S">', '</span>web: <span class="S">' + engine + '</span> server<span class="S">' + fileExtension);</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">        createFileByTemplate('</span>package.json<span class="S">', '</span>package.json<span class="S">', [replaceAppname, replaceViewEngine]);</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">        fs.chmodSync(srv, 0755);</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">        process.exit();</span></code></li><li class=""><code><span class="S">    }</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">    ~~~C9~~~</span></code></li><li class=""><code><span class="S">    function modelGenerator(args) {</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">        parseOptions('</span>model<span class="S">');</span></code></li><li class="uncovered"><code><span class="S">        var model = options.model, code = '</span>';</code></li><li class=""><code>        <span class="kwrd">if</span> (!model) <span class="gly">{</span> </code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Model name required'</span>).red.bold);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (model.<span class="func">match</span>(/\<span class="C">//)) {</span></code></li><li class="uncovered"><code>            model = model.<span class="func">match</span>(<span class="R">/\/([^\/]+)$/</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (model.<span class="func">match</span>(<span class="R">/\./</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            model = model.<span class="func">match</span>(<span class="R">/\.([^\.]+)$/</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> Model = model<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + model.<span class="func">slice</span>(1);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> attrs = <span class="gly">[</span><span class="gly">]</span>, result = <span class="gly">[</span><span class="gly">]</span>, driver = <span class="func">ormDriver</span>();</code></li><li class=""><code>        options.<span class="func">forEach</span>(<span class="kwrd">function</span> (arg) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> property = arg.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>0<span class="gly">]</span>,</code></li><li class=""><code>            plainType = arg.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>1<span class="gly">]</span>,</code></li><li class="uncovered"><code>            type = <span class="func">formatType</span>(plainType);</code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>                attrs.<span class="func">push</span>(<span class="S">'    property \''</span> + property + <span class="S">'\', '</span> + type);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                attrs.<span class="func">push</span>(<span class="S">'    property(\''</span> + property + <span class="S">'\', '</span> + type + <span class="S">');'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            result.<span class="func">push</span>(<span class="gly">{</span>name: property, type: type, plainType: plainType<span class="gly">}</span>);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/models/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFile</span>(<span class="S">'app/models/'</span> + model + fileExtension, <span class="S">''</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class=""><code>            code = Model + <span class="S">' = describe \''</span> + Model + <span class="S">'\', () ->\n'</span> +</code></li><li class="uncovered"><code>            attrs.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>) + <span class="S">'\n'</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            code = <span class="S">'var '</span> + Model + <span class="S">' = describe(\''</span> + Model + <span class="S">'\', function () {\n'</span> +</code></li><li class="uncovered"><code>            attrs.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>) + <span class="S">'\n});'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="func">appendToFile</span>(<span class="S">'db/schema'</span> + fileExtension, code);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> result;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Generates single controller and related views. Accepts arguments:</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     *  - controller name</span></code></li><li class=""><code><span class="C">     *  - action names</span></code></li><li class=""><code><span class="C">     *  - `--coffee` modifier can be passed to generate code in coffee</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * Affected files:</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     *  - app/controllers/controller_name_controller.js</span></code></li><li class=""><code><span class="C">     *  - app/views/controller_name/action1.ejs</span></code></li><li class=""><code><span class="C">     *  - app/views/controller_name/action2.ejs</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">controllerGenerator</span>(args) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">parseOptions</span>(<span class="S">'controller'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> controller = options.controller;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!controller) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Usage example: railway g controller controllername actionName anotherActionName'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'               railway g controller controllername actionName anotherActionName --coffee'</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> fileExtension;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> actions;</code></li><li class=""><code>        <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>            fileExtension = <span class="S">'.coffee'</span>;</code></li><li class="uncovered"><code>            actions = <span class="gly">[</span><span class="S">'load \'application\''</span><span class="gly">]</span>;</code></li><li class=""><code>            options.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="uncovered"><code>                actions.<span class="func">push</span>(<span class="S">'action \''</span> + action + <span class="S">'\', () -> \n    render\n        title: "'</span> + controller + <span class="S">'#'</span> + action + <span class="S">'"'</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            fileExtension = <span class="S">'.js'</span>;</code></li><li class="uncovered"><code>            actions = <span class="gly">[</span><span class="S">'load(\'application\');'</span><span class="gly">]</span>;</code></li><li class=""><code>            options.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="uncovered"><code>                actions.<span class="func">push</span>(<span class="S">'action(\''</span> + action + <span class="S">'\', function () {\n    render({\n        title: "'</span> + controller + <span class="S">'#'</span> + action + <span class="S">'"\n    });\n});'</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ns = controller.<span class="func">split</span>(<span class="S">'/'</span>);</code></li><li class="uncovered"><code>        ns.<span class="func">pop</span>();</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/controllers/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/controllers/'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// controller</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> filename = <span class="S">'app/controllers/'</span> + controller + <span class="S">'_controller'</span>  + fileExtension;</code></li><li class="uncovered"><code>        <span class="func">createFile</span>(filename, actions.jo<span class="kwrd">in</span>(<span class="S">'\n\n'</span>));</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/helpers/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/helpers/'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// helper</span></code></li><li class="uncovered"><code>        filename = <span class="S">'app/helpers/'</span> + controller + <span class="S">'_helper.js'</span>;</code></li><li class="uncovered"><code>        <span class="func">createFile</span>(filename, <span class="S">'module.exports = {\n};'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// views</span></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/views/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span> + controller + <span class="S">'/'</span>);</code></li><li class=""><code></code></li><li class=""><code>        options.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">createView</span>(<span class="S">'app/views/'</span> + controller + <span class="S">'/'</span> + action, <span class="S">'default_action_view'</span>, <span class="gly">[</span>controller, action<span class="gly">]</span>);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Cucumis features generator</span></code></li><li class=""><code><span class="C">     * @deprecated</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">featuresGenerator</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'features/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'features/step_definitions/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'features/step_definitions/web_steps.js'</span>,   <span class="S">'features/step_definitions/web_steps.js'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'features/step_definitions/email_steps.js'</span>, <span class="S">'features/step_definitions/email_steps.js'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'features/step_definitions/jquery.js'</span>,      <span class="S">'features/step_definitions/jquery.js'</span>);</code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">require</span>(<span class="S">'cucumis'</span>);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Cucumis is not installed'</span>).red + <span class="S">' please run '</span> + <span class="func">$</span>(<span class="S">'npm install cucumis'</span>).yellow);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// Object.keys(global.models || []).forEach(function (name) {</span></code></li><li class=""><code>        <span class="C">//     cname = name;</span></code></li><li class=""><code>        <span class="C">//     var classDefinition = models[name];</span></code></li><li class=""><code>        <span class="C">//     classDefinition.implementation();</span></code></li><li class=""><code>        <span class="C">//     orm.mixPersistMethods(ctx[cname], {</span></code></li><li class=""><code>        <span class="C">//         className:    classDefinition.className,</span></code></li><li class=""><code>        <span class="C">//         tableName:    classDefinition.tableName,</span></code></li><li class=""><code>        <span class="C">//         primaryKey:   classDefinition.primaryKey,</span></code></li><li class=""><code>        <span class="C">//         properties:   classDefinition.properties,</span></code></li><li class=""><code>        <span class="C">//         associations: classDefinition.associations,</span></code></li><li class=""><code>        <span class="C">//         scopes:       classDefinition.scopes</span></code></li><li class=""><code>        <span class="C">//     });</span></code></li><li class=""><code>        <span class="C">// });</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Resource scaffolding generator. Accepts same arguments as model generator:</span></code></li><li class=""><code><span class="C">     * name of model (singilar) and list of model properties in</span></code></li><li class=""><code><span class="C">     * `property:type` format</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * It creates ready-to-use model, controller, controller tests (nodeunit),</span></code></li><li class=""><code><span class="C">     * routing rule, views and layout</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">crudGenerator</span>(args) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> driver = <span class="func">ormDriver</span>();</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> model = args<span class="gly">[</span>0<span class="gly">]</span>.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">pop</span>();</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> parents = args<span class="gly">[</span>0<span class="gly">]</span>.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">slice</span>(0, -1);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> models = <span class="func">pluralize</span>(model).toLower<span class="kwrd">Case</span>();</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!model) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Usage example: railway g crud post title:string content:string published:boolean'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'               railway g crud post title:string content:string published:boolean --coffee'</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ns = models.<span class="func">split</span>(<span class="S">'/'</span>);</code></li><li class="uncovered"><code>        ns.<span class="func">pop</span>();</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/controllers/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/controllers/'</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> result = modelGenerator.<span class="func">apply</span>(this, Array.prototype.slice.<span class="func">call</span>(arguments));</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code></li><li class="uncovered"><code>        <span class="func">createFile</span>(<span class="S">'app/controllers/'</span> + models + <span class="S">'_controller'</span> + fileExtension, <span class="func">controllerCode</span>(args<span class="gly">[</span>0<span class="gly">]</span>, driver, result));</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/helpers/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/helpers/'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">replaceModel</span>(code) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">return</span> code</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/new_model/g</span>, <span class="func">addParents</span>(<span class="S">'new_'</span>, parents, model))</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/edit_model/g</span>, <span class="func">addParents</span>(<span class="S">'edit_'</span>, parents, model, true))</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/path_to\.models/g</span>, <span class="func">addParents</span>(<span class="S">'path_to.'</span>, parents, models))</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/path_to\.model/g</span>, <span class="func">addParents</span>(<span class="S">'path_to.'</span>, parents, model, true))</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/(path_to\..*?\()model/g</span>, <span class="func">addParents</span>(<span class="S">'$1'</span>, parents.<span class="func">map</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span> <span class="kwrd">return</span> <span class="S">'params.'</span> + p + <span class="S">'_id'</span>;<span class="gly">}</span>), model, true, <span class="S">', '</span>))</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/models/g</span>, models)</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/model/g</span>, model.toLower<span class="kwrd">Case</span>())</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/Model/g</span>, <span class="func">camelize</span>(model, true))</code></li><li class="uncovered"><code>                .<span class="func">replace</span>(<span class="R">/VALID_ATTRIBUTES/</span>, result.<span class="func">map</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span> <span class="kwrd">return</span> attr.name + <span class="S">": ''"</span> <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">',\n        '</span>));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// helper</span></code></li><li class="uncovered"><code>        <span class="func">createFile</span>(<span class="S">'app/helpers/'</span> + models + <span class="S">'_helper.js'</span>, <span class="S">'module.exports = {\n};'</span>);</code></li><li class=""><code>        <span class="C">// tests</span></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'test/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'test/test_helper.js'</span>, <span class="S">'test_helper.js'</span>);</code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'test/controllers'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'test/controllers/'</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'test/controllers/'</span> + models + <span class="S">'_controller_test.js'</span>, <span class="S">'crud_controller_test.js'</span>, replaceModel);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// views</span></code></li><li class=""><code>        <span class="C">// _form partial</span></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/views/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/views/layouts/'</span>);</code></li><li class=""><code>        <span class="C">// layout</span></code></li><li class="uncovered"><code>        <span class="func">createViewByTemplate</span>(<span class="S">'app/views/layouts/'</span> + models + <span class="S">'_layout'</span>, <span class="S">'scaffold_layout'</span>, replaceModel);</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/'</span>);</code></li><li class="uncovered"><code>        <span class="func">createView</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/_form'</span>, <span class="S">'scaffold_form'</span>, result, replaceModel);</code></li><li class="uncovered"><code>        <span class="func">createView</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/show'</span>, <span class="S">'scaffold_show'</span>, result, replaceModel);</code></li><li class=""><code>        <span class="gly">[</span><span class="S">'new'</span>, <span class="S">'edit'</span>, <span class="S">'index'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (template) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">createViewByTemplate</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/'</span> + template, <span class="S">'scaffold_'</span> + template, replaceModel);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// route</span></code></li><li class=""><code>        <span class="kwrd">var</span> routesConfig = process.<span class="func">cwd</span>() + <span class="S">'/config/routes.js'</span>,</code></li><li class=""><code>            routes = fs.<span class="func">readFileSync</span>(routesConfig, <span class="S">'utf8'</span>)</code></li><li class=""><code>                .<span class="func">toString</span>()</code></li><li class=""><code>                .<span class="func">replace</span>(<span class="R">/\s+$/g</span>, <span class="S">''</span>)</code></li><li class=""><code>                .<span class="func">split</span>(<span class="S">'\n'</span>),</code></li><li class="uncovered"><code>            firstLine = routes.<span class="func">shift</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (firstLine.<span class="func">match</span>(<span class="R">/^exports\.routes = function \(map\) \{/</span>) && !routes.<span class="func">some</span>(containRoute)) <span class="gly">{</span></code></li><li class="uncovered"><code>            routes.<span class="func">unshift</span>(<span class="S">'    map.resources(\''</span> + models + <span class="S">'\');'</span>);</code></li><li class="uncovered"><code>            routes.<span class="func">unshift</span>(firstLine);</code></li><li class="uncovered"><code>            fs.<span class="func">writeFileSync</span>(routesConfig, routes.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>));</code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'patch'</span>).bold.blue + <span class="S">'  '</span> + routesConfig);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">containRoute</span>(line) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> m = line.<span class="func">match</span>(<span class="R">/^\s*map\.resources\(~~~S232~~~]+)~~~S233~~~.coffee~~~S234~~~.js~~~S235~~~.~~~S236~~~.~~~S237~~~/</span>..<span class="R">/templates/</span>crud_controller<span class="S">' + fileExtension);</span></code></li><li class=""><code><span class="S">        code = code</span></code></li><li class=""><code><span class="S">            .toString('</span>utf8<span class="S">')</span></code></li><li class=""><code><span class="S">            .replace(/new_model/g, addParents('</span>new_<span class="S">', parents, model))</span></code></li><li class=""><code><span class="S">            .replace(/edit_model/g, addParents('</span>edit_<span class="S">', parents, model, true))</span></code></li><li class=""><code><span class="S">            .replace(/path_to\.models/g, addParents('</span>path_to.<span class="S">', parents, models))</span></code></li><li class=""><code><span class="S">            .replace(/path_to\.model/g, addParents('</span>path_to.<span class="S">', parents, model, true))</span></code></li><li class=""><code><span class="S">            .replace(/(path_to\..*?\()this\.model/g, addParents('</span>$1<span class="S">', parents.map(function (p) { return '</span>params.<span class="S">' + p + '</span>_id<span class="S">';}), '</span>this.<span class="S">' + model, true, '</span>, <span class="S">'))</span></code></li><li class=""><code><span class="S">            .replace(/models/g, models)</span></code></li><li class=""><code><span class="S">            .replace(/model/g, model.toLowerCase())</span></code></li><li class=""><code><span class="S">            .replace(/Model/g, camelize(model, true))</span></code></li><li class=""><code><span class="S">            .replace(/FILTER_PROPERTIES/g, '</span><span class="gly">[</span><span class="S">' + result.map(function (p) {</span></code></li><li class="uncovered"><code><span class="S">                return "'</span>" + p.name + <span class="S">"'"</span>;</code></li><li class="uncovered"><code>            <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">']'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> code;</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">addParents</span>(prefix, parents, base, skipParams, jo<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> name;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (!jo<span class="kwrd">in</span>) jo<span class="kwrd">in</span> = <span class="S">'_'</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (parents.length) <span class="gly">{</span></code></li><li class="uncovered"><code>            name = prefix + parents.jo<span class="kwrd">in</span>(jo<span class="kwrd">in</span>) + jo<span class="kwrd">in</span> + base;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            name = prefix + base;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (skipParams) <span class="kwrd">return</span> name;</code></li><li class=""><code>        <span class="kwrd">return</span> name + <span class="S">'('</span> + parents.<span class="func">map</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="S">'params.'</span> + p + <span class="S">'_id'</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Parse command line options</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">parseOptions</span>(defaultKeyName) <span class="gly">{</span></code></li><li class="uncovered"><code>        options = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>        options.tpl = app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>;</code></li><li class="uncovered"><code>        options.coffee = app.<span class="func">enabled</span>(<span class="S">'coffee'</span>);</code></li><li class="uncovered"><code>        options.db = <span class="S">'memory'</span>;</code></li><li class="uncovered"><code>        options.stylus = false;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> key = defaultKeyName <span class="gly">|</span><span class="gly">|</span> false;</code></li><li class=""><code>        args.<span class="func">forEach</span>(<span class="kwrd">function</span> (arg) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (arg.<span class="func">slice</span>(0, 2) == <span class="S">'--'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                key = arg.<span class="func">slice</span>(2);</code></li><li class="uncovered"><code>                options<span class="gly">[</span>key<span class="gly">]</span> = true;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (arg<span class="gly">[</span>0<span class="gly">]</span> == <span class="S">'-'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                key = arg.<span class="func">slice</span>(1);</code></li><li class="uncovered"><code>                options<span class="gly">[</span>key<span class="gly">]</span> = true;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (key) <span class="gly">{</span></code></li><li class="uncovered"><code>                options<span class="gly">[</span>key<span class="gly">]</span> = arg;</code></li><li class="uncovered"><code>                key = false;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                options.<span class="func">push</span>(arg);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>        <span class="kwrd">if</span> (options.nocoffee) <span class="gly">{</span></code></li><li class="uncovered"><code>            options.coffee = false;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create directory</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createDir</span>(dir) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> root = process.<span class="func">cwd</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (options.appname && !createDir.rootCreated) <span class="gly">{</span></code></li><li class="uncovered"><code>            createDir.rootCreated = true;</code></li><li class="uncovered"><code>            <span class="func">createDir</span>(<span class="S">''</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (options.appname) <span class="gly">{</span></code></li><li class="uncovered"><code>            dir = path.jo<span class="kwrd">in</span>(options.appname, dir);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(path.jo<span class="kwrd">in</span>(root, dir))) <span class="gly">{</span></code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'exists'</span>).bold.grey + <span class="S">'  '</span> + dir);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            fs.<span class="func">mkdirSync</span>(path.jo<span class="kwrd">in</span>(root, dir), 0755);</code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'create'</span>).bold.green + <span class="S">'  '</span> + dir);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Append `contents` to a file</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} contents</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">appendToFile</span>(filename, contents) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> root = process.<span class="func">cwd</span>(),</code></li><li class="uncovered"><code>            fd = fs.<span class="func">openSync</span>(path.jo<span class="kwrd">in</span>(root, filename), <span class="S">'a'</span>);</code></li><li class="uncovered"><code>        fs.<span class="func">writeSync</span>(fd, contents);</code></li><li class="uncovered"><code>        fs.<span class="func">closeSync</span>(fd);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create file with given `contents`</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} contents</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createFile</span>(filename, contents) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> root = process.<span class="func">cwd</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (options.appname) <span class="gly">{</span></code></li><li class="uncovered"><code>            filename = path.jo<span class="kwrd">in</span>(options.appname, filename);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> fullPath = root + <span class="S">'/'</span> + filename;</code></li><li class=""><code>        <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(fullPath)) <span class="gly">{</span></code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'exists'</span>).bold.grey + <span class="S">'  '</span> + filename);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            fs.<span class="func">writeFileSync</span>(fullPath, contents);</code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'create'</span>).bold.green + <span class="S">'  '</span> + filename);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> fullPath;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create file with name `filename` using contents of `template` file.</span></code></li><li class=""><code><span class="C">     * Run `prepare` function before returning result</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} template</span></code></li><li class=""><code><span class="C">     * @param {Function} prepare - called with (text: {String}),</span></code></li><li class=""><code><span class="C">     * should return {String}</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createFileByTemplate</span>(filename, template, prepare) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!template.<span class="func">match</span>(<span class="R">/\..+$/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code></li><li class="uncovered"><code>            template += fileExtension;</code></li><li class="uncovered"><code>            filename += fileExtension;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> text = fs.<span class="func">readFileSync</span>(path.jo<span class="kwrd">in</span>(__dirname, <span class="S">'/../templates/'</span>, template));</code></li><li class=""><code>        <span class="kwrd">if</span> (prepare) <span class="gly">{</span></code></li><li class="uncovered"><code>            text = text.<span class="func">toString</span>(<span class="S">'utf8'</span>);</code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> prepare === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                prepare = <span class="gly">[</span>prepare<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            prepare.<span class="func">forEach</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span></code></li><li class="uncovered"><code>                text = <span class="func">p</span>(text);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">createFile</span>(filename, text);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create view file with name `filename` using contents of `template` file.</span></code></li><li class=""><code><span class="C">     * Run `prepare` function before returning result. It look for -tpl option</span></code></li><li class=""><code><span class="C">     * and result file with proper extension and contents</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} template</span></code></li><li class=""><code><span class="C">     * @param {Function} prepare - called with (text: {String}),</span></code></li><li class=""><code><span class="C">     * should return {String}</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createViewByTemplate</span>(filename, template, prepare) <span class="gly">{</span></code></li><li class="uncovered"><code>        options.tpl = options.tpl <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> package = options.tpl + <span class="S">'-ext'</span>, tpl;</code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            tpl = <span class="func">require</span>(package);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Templating engine '</span> + options.tpl + <span class="S">' is not supported'</span>).red);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> text = fs.<span class="func">readFileSync</span>(tpl.<span class="func">template</span>(template));</code></li><li class=""><code>        <span class="kwrd">if</span> (prepare) <span class="gly">{</span></code></li><li class="uncovered"><code>            text = <span class="func">prepare</span>(text.<span class="func">toString</span>(<span class="S">'utf8'</span>));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">createFile</span>(filename + tpl.extension, text);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createView</span>(filename, template, data, fn) <span class="gly">{</span></code></li><li class="uncovered"><code>        options.tpl = options.tpl <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> package = options.tpl + <span class="S">'-ext'</span>;</code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> tpl = <span class="func">require</span>(package);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Templating engine '</span> + options.tpl + <span class="S">' is not supported'</span>).red);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> text = tpl.<span class="func">templateText</span>(template, data);</code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> fn === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            text = <span class="func">fn</span>(text.<span class="func">toString</span>());</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">createFile</span>(filename + tpl.extension, text);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createParents</span>(ns, d) <span class="gly">{</span></code></li><li class=""><code>        ns.<span class="func">forEach</span>(<span class="kwrd">function</span> (dir) <span class="gly">{</span></code></li><li class="uncovered"><code>            d = path.jo<span class="kwrd">in</span>(d, dir);</code></li><li class="uncovered"><code>            <span class="func">createDir</span>(d);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">formatType</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>        name = (name <span class="gly">|</span><span class="gly">|</span> <span class="S">'string'</span>).toLower<span class="kwrd">Case</span>();</code></li><li class=""><code>        <span class="kwrd">switch</span> (name) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'string'</span>:   <span class="kwrd">return</span> <span class="S">'String'</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'date'</span>:     <span class="kwrd">return</span> <span class="S">'Date'</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'bool'</span>:</code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'boolean'</span>:  <span class="kwrd">return</span> <span class="S">'Boolean'</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'int'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'real'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'float'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'decimal'</span>:</code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'number'</span>:   <span class="kwrd">return</span> <span class="S">'Number'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="S">'"'</span> + name + <span class="S">'"'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">replaceAppname</span>(template) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> template.<span class="func">replace</span>(<span class="R">/APPNAME/g</span>, options.appname <span class="gly">|</span><span class="gly">|</span> <span class="S">'default'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">replaceViewEngine</span>(template) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> template.<span class="func">replace</span>(<span class="R">/VIEWENGINE/g</span>, options.tpl <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">replacePrependMiddleware</span>(template) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> mw = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (options.stylus) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>                mw.<span class="func">push</span>(<span class="S">"app.use require('stylus').middleware\n        force: true, src: app.root + '/app/assets', dest: app.root + '/public', compress: true"</span>.<span class="func">replace</span>(<span class="R">/, /g</span>, <span class="S">',\n        '</span>));</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                mw.<span class="func">push</span>(<span class="S">"app.use(require('stylus').middleware({\n        force: true, src: app.root + '/app/assets', dest: app.root + '/public', compress: true\n    }));"</span>.<span class="func">replace</span>(<span class="R">/, /g</span>, <span class="S">',\n        '</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> template.<span class="func">replace</span>(<span class="R">/PREPEND_MIDDLEWARE/g</span>, mw.jo<span class="kwrd">in</span>(<span class="S">'\n    '</span>));</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Return default ORM driver, based on config/database.json</span></code></li><li class=""><code><span class="C">     * @deprecated</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">ormDriver</span>() <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!ormDriver.config) <span class="gly">{</span></code></li><li class="uncovered"><code>            ormDriver.config = JSON.<span class="func">parse</span>(<span class="func">require</span>(<span class="S">'fs'</span>).<span class="func">readFileSync</span>(process.<span class="func">cwd</span>() + <span class="S">'/config/database.json'</span>, <span class="S">'utf8'</span>)).development;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> ormDriver.config.driver;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code><span class="gly">}</span>)();</code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-helpers-js" class="filename" name="lib-helpers-js" onclick="var el = document.getElementById('lib-helpers-js'); el.style.display = el.style.display ? '' : 'none';">lib/helpers.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 50%"><strong>50%</strong> [101/380]</div></div></div></div><div id="lib-helpers-js" style="display:none;"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">var</span> path       = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    fs         = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class="covered"><code>    crypto     = <span class="func">require</span>(<span class="S">'crypto'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Import utilities</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">var</span> htmlTagParams = <span class="func">require</span>(<span class="S">'./railway_utils'</span>).html_tag_params,</code></li><li class=""><code>    safe_merge = <span class="func">require</span>(<span class="S">'./railway_utils'</span>).safe_merge,</code></li><li class=""><code>    humanize   = <span class="func">require</span>(<span class="S">'./railway_utils'</span>).humanize,</code></li><li class="covered"><code>    undef;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Config</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">var</span> regexps = <span class="gly">{</span></code></li><li class=""><code>  <span class="S">'cached'</span>: /^cache\<span class="C">//,</span></code></li><li class=""><code>  <span class="S">'isHttp'</span>: <span class="R">/^https?:\/\/|\/</span>\<span class="C">//</span></code></li><li class=""><code><span class="gly">}</span>,</code></li><li class=""><code>exts = <span class="gly">{</span></code></li><li class=""><code>  <span class="S">'css'</span>: <span class="S">'.css'</span>,</code></li><li class=""><code>  <span class="S">'js'</span> : <span class="S">'.js'</span></code></li><li class=""><code><span class="gly">}</span>,</code></li><li class=""><code>paths = <span class="gly">{</span></code></li><li class=""><code>  <span class="S">'css'</span>: <span class="S">'/stylesheets/'</span>,</code></li><li class=""><code>  <span class="S">'js'</span> : <span class="S">'/javascripts/'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Publish HelperSet</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>module.exports = <span class="kwrd">new</span> <span class="func">HelperSet</span>(null);</code><span class="hits">1</span></li><li class="covered"><code>module.exports.HelperSet = HelperSet;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Set of helper methods</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">HelperSet</span>(ctl) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> controller = ctl;</code><span class="hits">3</span></li><li class="covered"><code>    this.controller = ctl;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    this.csrf_meta_tag = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">return</span> controller && controller.<span class="func">protectedFromForgery</span>() ? <span class="gly">[</span></code></li><li class=""><code>            <span class="S">'<meta name="csrf-param" content="'</span> + controller.request.csrfParam + <span class="S">'"/>'</span>,</code></li><li class=""><code>            <span class="S">'<meta name="csrf-token" content="'</span> + controller.request.csrfToken + <span class="S">'"/>'</span></code></li><li class="uncovered"><code>        <span class="gly">]</span>.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>) : <span class="S">''</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Make helpers local to query</span></code></li><li class=""><code><span class="C"> * @returns Object containing all helpers</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>module.exports.personalize = <span class="kwrd">function</span> (controller) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">new</span> module.exports.<span class="func">HelperSet</span>(controller);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return bunch of stylesheets link tags</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Examlple:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     <link href="/stylesheets/all.css"  media="screen" rel="stylesheet" type="text/css" /></span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.stylesheetLinkTag = <span class="kwrd">function</span> <span class="func">stylesheetLinkTag</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!paths.css <span class="gly">|</span><span class="gly">|</span> !paths.stylesheets) <span class="gly">{</span></code></li><li class="covered"><code>      paths.css = app.settings.cssDirectory <span class="gly">|</span><span class="gly">|</span> <span class="S">'/stylesheets/'</span>;</code><span class="hits">1</span></li><li class="covered"><code>      paths.stylesheets = paths.css;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>  </code></li><li class="covered"><code>    <span class="kwrd">var</span> args = Array.prototype.slice.<span class="func">call</span>(arguments);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> options = <span class="gly">{</span>media: <span class="S">'screen'</span>, rel: <span class="S">'stylesheet'</span>, type: <span class="S">'text/css'</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> links = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> == <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        options = <span class="func">safe_merge</span>(options, args.<span class="func">pop</span>());</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="func">mergeFiles</span>(<span class="S">'stylesheets'</span>, args).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="covered"><code>        delete options.href;</code><span class="hits">5</span></li><li class=""><code>        <span class="C">// there should be an option to change the /stylesheets/ folder</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> href = <span class="func">checkFile</span>(<span class="S">'css'</span>, file);</code><span class="hits">5</span></li><li class="covered"><code>        links.<span class="func">push</span>(<span class="func">genericTagSelfclosing</span>(<span class="S">'link'</span>, options, <span class="gly">{</span> href: href <span class="gly">}</span>));</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> links.jo<span class="kwrd">in</span>(<span class="S">'\n    '</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.prototype.stylesheet_link_tag = HelperSet.prototype.stylesheetLinkTag;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Generates set of javascript includes composed from arguments</span></code></li><li class=""><code><span class="C"> * @param String script filename</span></code></li><li class=""><code><span class="C"> * @example</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     <%- javascript_include_tag('rails', 'application') %></span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * generates</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     <script type="text/javascript" src="/javascripts/rails.js"></script></span></code></li><li class=""><code><span class="C"> *     <script type="text/javascript" src="/javascripts/application.js"></script></span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.javascriptIncludeTag = <span class="kwrd">function</span> <span class="func">javascriptIncludeTag</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!paths.js <span class="gly">|</span><span class="gly">|</span> !paths.javascripts) <span class="gly">{</span></code></li><li class=""><code>      paths.js = app.settings.jsDirectory <span class="gly">|</span><span class="gly">|</span> <span class="S">'/javascripts/'</span></code></li><li class="covered"><code>      paths.javascripts = paths.js;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> args = Array.prototype.slice.<span class="func">call</span>(arguments);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> options = <span class="gly">{</span>type: <span class="S">'text/javascript'</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> == <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        options = <span class="func">safe_merge</span>(options, args.<span class="func">pop</span>());</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> scripts = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="func">mergeFiles</span>(<span class="S">'javascripts'</span>, args).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// there should be an option to change the /javascripts/ folder</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> href = <span class="func">checkFile</span>(<span class="S">'js'</span>, file);</code><span class="hits">5</span></li><li class="covered"><code>        delete options.src;</code><span class="hits">5</span></li><li class="covered"><code>        scripts.<span class="func">push</span>(<span class="func">genericTag</span>(<span class="S">'script'</span>, <span class="S">''</span>, options, <span class="gly">{</span>src: href<span class="gly">}</span>));</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> scripts.jo<span class="kwrd">in</span>(<span class="S">'\n    '</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.prototype.javascript_include_tag = HelperSet.prototype.javascriptIncludeTag;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> merged = <span class="gly">{</span></code></li><li class=""><code>    stylesheets: <span class="gly">{</span>ext: exts.css<span class="gly">}</span>,</code></li><li class=""><code>    javascripts: <span class="gly">{</span>ext: exts.js<span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Merge files when caching enabled</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - app.set('merge javascripts')</span></code></li><li class=""><code><span class="C"> * - app.set('merge stylesheets')</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">mergeFiles</span>(scope, files) <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// ensure that feature is enabled</span></code></li><li class=""><code>    <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'merge '</span> + scope)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> files;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">var</span> ext  = merged<span class="gly">[</span>scope<span class="gly">]</span>.ext,</code></li><li class=""><code>      result = <span class="gly">[</span><span class="gly">]</span>,</code></li><li class=""><code>      shasum = crypto.<span class="func">createHash</span>(<span class="S">'sha1'</span>),</code></li><li class=""><code>      minify = <span class="gly">[</span><span class="gly">]</span>,</code></li><li class="uncovered"><code>      directory = merged<span class="gly">[</span>scope<span class="gly">]</span>.directory = paths<span class="gly">[</span>scope<span class="gly">]</span>.<span class="func">replace</span>(<span class="R">/(\/+)/g</span>, <span class="S">''</span>);</code></li><li class=""><code>    <span class="C">// only merge local files</span></code></li><li class=""><code>    files.<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!regexps.isHttp.<span class="func">test</span>(file)) <span class="gly">{</span></code></li><li class="uncovered"><code>            shasum.<span class="func">update</span>(file);</code></li><li class="uncovered"><code>            minify.<span class="func">push</span>(file);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            result.<span class="func">push</span>(file);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// calculate name of new script based on names of merged files</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> digest = shasum.<span class="func">digest</span>(<span class="S">'hex'</span>);</code></li><li class=""><code>    <span class="C">// check cache state (undefined = not cached, false = cache in progress, String = cached)</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> cached = merged<span class="gly">[</span>scope<span class="gly">]</span><span class="gly">[</span>digest<span class="gly">]</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (cached) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// push resulted filename to result</span></code></li><li class="uncovered"><code>        result.<span class="func">push</span>(cached);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// we have no cache at the moment, just return files</span></code></li><li class="uncovered"><code>        result = result.<span class="func">concat</span>(minify);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// if caching process is not started yet</span></code></li><li class=""><code>        <span class="kwrd">if</span> (cached !== false) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// mark caching process as started</span></code></li><li class="uncovered"><code>            merged<span class="gly">[</span>scope<span class="gly">]</span><span class="gly">[</span>digest<span class="gly">]</span> = false;</code></li><li class=""><code>            <span class="C">// write resulted script as merged `minify` files</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> stream = fs.<span class="func">createWriteStream</span>(path.jo<span class="kwrd">in</span>(app.root, <span class="S">'public'</span>, directory, <span class="S">'cache'</span>, digest + ext));</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> counter = 0;</code></li><li class=""><code>            minify.<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> filename = path.jo<span class="kwrd">in</span>(app.root, <span class="S">'public'</span>, directory, file + ext);</code></li><li class=""><code>                path.<span class="func">exists</span>(filename, <span class="kwrd">function</span> (exists) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (exists) <span class="gly">{</span></code></li><li class="uncovered"><code>                        counter += 1;</code></li><li class=""><code>                        fs.<span class="func">readFile</span>(filename, <span class="S">'utf8'</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>                            stream.<span class="func">write</span>(<span class="S">'~~~C32~~~</span></code></li><li class=""><code><span class="S">                            stream.write(data + '</span>\n<span class="S">');</span></code></li><li class=""><code><span class="S">                            done();</span></code></li><li class=""><code><span class="S">                        });</span></code></li><li class=""><code><span class="S">                    }</span></code></li><li class=""><code><span class="S">                })</span></code></li><li class=""><code><span class="S">            });</span></code></li><li class=""><code><span class="S">            function done () {</span></code></li><li class=""><code><span class="S">                if (--counter === 0) {</span></code></li><li class=""><code><span class="S">                    stream.end();</span></code></li><li class=""><code><span class="S">                }</span></code></li><li class=""><code><span class="S">            }</span></code></li><li class=""><code><span class="S">            ~~~C33~~~</span></code></li><li class=""><code><span class="S">            stream.on('</span>close<span class="S">', function () {</span></code></li><li class=""><code><span class="S">                merged[scope][digest] = ['</span>cache<span class="S">', digest].join('</span><span class="R">/~~~S51~~~remote~~~S52~~~method~~~S53~~~jsonp~~~S54~~~confirm~~~S55~~~a~~~S56~~~function~~~S57~~~POST~~~S58~~~GET~~~S59~~~POST~~~S60~~~POST~~~S61~~~remote~~~S62~~~jsonp~~~S63~~~confirm~~~S64~~~<form~~~S65~~~>~~~S66~~~function~~~S67~~~</</span>form><span class="S">');</span></code></li><li class=""><code><span class="S">};</span></code></li><li class=""><code><span class="S">HelperSet.prototype.form_tag = HelperSet.prototype.formTag;</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">HelperSet.prototype.errorMessagesFor = function errorMessagesFor(resource) {</span></code></li><li class="uncovered"><code><span class="S">    var out = '</span>';</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> h = this;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (resource.errors) <span class="gly">{</span></code></li><li class="uncovered"><code>        out += <span class="func">genericTag</span>(<span class="S">'div'</span>, <span class="func">printErrors</span>(), <span class="gly">{</span>class: <span class="S">'alert alert-error'</span><span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> out;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">printErrors</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> out = <span class="S">'<p>'</span>;</code></li><li class="uncovered"><code>        out += <span class="func">genericTag</span>(<span class="S">'strong'</span>, <span class="S">'Validation failed. Fix following errors before you continue:'</span>);</code></li><li class="uncovered"><code>        out += <span class="S">'</p>'</span>;</code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> prop <span class="kwrd">in</span> resource.errors) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (resource.errors.<span class="func">hasOwnProperty</span>(prop)) <span class="gly">{</span></code><span class="hits">1</span></li><li class="covered"><code>                out += <span class="S">'<ul>'</span>;</code><span class="hits">1</span></li><li class=""><code>                resource.errors<span class="gly">[</span>prop<span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (msg) <span class="gly">{</span></code></li><li class="uncovered"><code>                    out += <span class="func">genericTag</span>(<span class="S">'li'</span>, prop + <span class="S">' '</span> + msg, <span class="gly">{</span>class: <span class="S">'error-message'</span><span class="gly">}</span>);</code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>                out += <span class="S">'</ul>'</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> out;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Form fields for resource helper</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.fields_<span class="kwrd">for</span> = <span class="kwrd">function</span> (resource, block) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    arguments.callee.buf = arguments.callee.caller.buf;</code></li><li class="uncovered"><code>    resource = resource <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> resourceName = resource && resource.constructor && resource.constructor.modelName <span class="gly">|</span><span class="gly">|</span> false;</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> complexNames = (app.<span class="func">set</span>(<span class="S">'view options'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).complexNames;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">makeName</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> complexNames && resourceName ? (resourceName + <span class="S">'['</span> + name + <span class="S">']'</span>) : name;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">makeId</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> complexNames && resourceName ? (resourceName + <span class="S">'_'</span> + name) : name;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="func">block</span>(<span class="gly">{</span></code></li><li class=""><code>        input: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="kwrd">if</span> (params.value === undef) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.value = resource<span class="gly">[</span>name<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.prototype.<span class="func">input_tag</span>(<span class="gly">{</span></code></li><li class=""><code>                name: <span class="func">makeName</span>(name),</code></li><li class=""><code>                id: <span class="func">makeId</span>(name)</code></li><li class="uncovered"><code>            <span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        checkbox: <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.prototype.<span class="func">input_tag</span>(<span class="gly">{</span></code></li><li class="covered"><code>                name: <span class="func">makeName</span>(name),</code><span class="hits">1</span></li><li class="covered"><code>                id: <span class="func">makeId</span>(name),</code><span class="hits">1</span></li><li class=""><code>                value: 1,</code></li><li class=""><code>                checked: resource<span class="gly">[</span>name<span class="gly">]</span> ? <span class="S">'checked'</span> : undef,</code></li><li class=""><code>                type: <span class="S">'checkbox'</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        file: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.prototype.<span class="func">input_tag</span>(<span class="gly">{</span></code></li><li class=""><code>                name: <span class="func">makeName</span>(name),</code></li><li class=""><code>                id: <span class="func">makeId</span>(name),</code></li><li class=""><code>                type: <span class="S">'file'</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        label: <span class="kwrd">function</span> (name, caption, params) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.prototype.<span class="func">label_tag</span>(</code></li><li class=""><code>                caption <span class="gly">|</span><span class="gly">|</span> self.controller.<span class="func">t</span>(<span class="S">'models.'</span> + resource.constructor.modelName + <span class="S">'.fields.'</span> + name, <span class="func">humanize</span>(name)),</code></li><li class=""><code>                <span class="gly">{</span><span class="kwrd">for</span>: <span class="func">makeId</span>(name) <span class="gly">}</span>,</code></li><li class="uncovered"><code>                params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        submit: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'button'</span>, name <span class="gly">|</span><span class="gly">|</span> <span class="S">'Commit'</span>, <span class="gly">{</span>type: <span class="S">'submit'</span><span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        textarea: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'textarea'</span>, <span class="func">sanitizeHTML</span>(resource<span class="gly">[</span>name<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>), <span class="gly">{</span>name: <span class="func">makeName</span>(name), id: <span class="func">makeId</span>(name)<span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code><span class="gly">}</span>;</code></li><li class="covered"><code></code><span class="hits">1</span></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Form for resource helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {ModelInstance} resource</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} block</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.form_<span class="kwrd">for</span> = <span class="kwrd">function</span> (resource, params, block) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> buf = arguments.callee.buf = arguments.callee.caller.buf;</code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">form_tag</span>(params, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        arguments.callee.buf = buf;</code></li><li class="uncovered"><code>        self.fields_<span class="kwrd">for</span>(resource, block);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Input tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     <input type="text" ... /></span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.input_tag = <span class="kwrd">function</span> (params, override) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'<input'</span> + <span class="func">htmlTagParams</span>(params, override) + <span class="S">' />'</span>;</code></li><li class="uncovered"><code><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Label tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     <label>text</label></span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.label_tag = <span class="kwrd">function</span> (text, params, override) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'label'</span>, text, params, override);</code></li><li class="uncovered"><code><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Cross-site request forgery hidden inputs</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.prototype.csrf_tag = <span class="kwrd">function</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'<input type="hidden" name="'</span> + this.controller.request.csrfParam + <span class="S">'" value="'</span> + this.controller.request.csrfToken + <span class="S">'" />'</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>HelperSet.prototype.sanitize = sanitizeHTML;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Private util methods</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Returns html code of one tag with contents</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param String name - name of tag</span></code></li><li class=""><code><span class="C"> * @param String inner - inner html</span></code></li><li class=""><code><span class="C"> * @param Object params - set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param Object override - set params to override params in previous arg</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">genericTag</span>(name, inner, params, override) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'<'</span> + name + <span class="func">htmlTagParams</span>(params, override) + <span class="S">'>'</span> + inner + <span class="S">'</'</span> + name + <span class="S">'>'</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">function</span> <span class="func">genericTagSelfclosing</span>(name, params, override) <span class="gly">{</span></code><span class="hits">1</span></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'<'</span> + name + <span class="func">htmlTagParams</span>(params, override) + <span class="S">' />'</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">dataParam</span>(key) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        this<span class="gly">[</span><span class="S">'data-'</span> + key<span class="gly">]</span> = this<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class="uncovered"><code>        delete this<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Escape &, &lt; and > symbols</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">sanitizeHTML</span>(html) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> html.<span class="func">replace</span>(<span class="R">/&/g</span>, <span class="S">'&amp;'</span>).<span class="func">replace</span>(<span class="R">/>/g</span>, <span class="S">'&gt;'</span>).<span class="func">replace</span>(<span class="R">/</g</span>, <span class="S">'&lt;'</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code></code><span class="hits">1</span></li><li class=""><code><span class="kwrd">function</span> <span class="func">checkProd</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>  <span class="kwrd">return</span> app.settings.env === <span class="S">'production'</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">checkFile</span>(type, file) <span class="gly">{</span></code></li><li class=""><code>  <span class="kwrd">var</span> isExternalFile = regexps.isHttp.<span class="func">test</span>(file),</code></li><li class=""><code>    isCached         = file.<span class="func">match</span>(regexps.cached),</code></li><li class=""><code>    href             = !isExternalFile ? paths<span class="gly">[</span>type<span class="gly">]</span> + file + exts<span class="gly">[</span>type<span class="gly">]</span> : file,</code></li><li class="covered"><code>    isProd           = <span class="func">checkProd</span>();</code><span class="hits">1</span></li><li class=""><code>  <span class="kwrd">if</span> (!isCached && !isProd && !isExternalFile) <span class="gly">{</span></code></li><li class=""><code>      href += <span class="S">'?'</span> + Date.<span class="func">now</span>()</code></li><li class=""><code>  <span class="gly">}</span></code></li><li class="uncovered"><code>  <span class="kwrd">return</span> href;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-railway-utils-js" class="filename" name="lib-railway-utils-js" onclick="var el = document.getElementById('lib-railway-utils-js'); el.style.display = el.style.display ? '' : 'none';">lib/railway_utils.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 87%"><strong>87%</strong> [93/203]</div></div></div></div><div id="lib-railway-utils-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> undef, sys = <span class="func">require</span>(<span class="S">'util'</span>),</code></li><li class=""><code>    path = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    Module = <span class="func">require</span>(<span class="S">'module'</span>),</code></li><li class="covered"><code>    vm = <span class="func">require</span>(<span class="S">'vm'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code>exports.html_tag_params = <span class="kwrd">function</span> (params, override) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> maybe_params = <span class="S">''</span>;</code><span class="hits">10</span></li><li class="covered"><code>    <span class="func">safe_merge</span>(params, override);</code><span class="hits">10</span></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> params) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (params<span class="gly">[</span>key<span class="gly">]</span> != undef) <span class="gly">{</span></code></li><li class="covered"><code>            maybe_params += <span class="S">' '</span> + key + <span class="S">'="'</span> + params<span class="gly">[</span>key<span class="gly">]</span>.<span class="func">toString</span>().<span class="func">replace</span>(<span class="R">/&/g</span>, <span class="S">'&amp;'</span>).<span class="func">replace</span>(/<span class="S">"/g, '&quot;') + '"</span>';</code><span class="hits">30</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> maybe_params;</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> safe_merge = exports.safe_merge = <span class="kwrd">function</span> (merge_what) <span class="gly">{</span></code></li><li class="covered"><code>    merge_what = merge_what <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">12</span></li><li class=""><code>    Array.prototype.slice.<span class="func">call</span>(arguments).<span class="func">forEach</span>(<span class="kwrd">function</span> (merge_with, i) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (i == 0) <span class="kwrd">return</span>;</code><span class="hits">22</span></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> merge_with) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (!merge_with.<span class="func">hasOwnProperty</span>(key) <span class="gly">|</span><span class="gly">|</span> key <span class="kwrd">in</span> merge_what) <span class="kwrd">continue</span>;</code><span class="hits">44</span></li><li class="covered"><code>            merge_what<span class="gly">[</span>key<span class="gly">]</span> = merge_with<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">44</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">12</span></li><li class="covered"><code>    <span class="kwrd">return</span> merge_what;</code><span class="hits">12</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.humanize = <span class="kwrd">function</span> (underscored) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> res = underscored.<span class="func">replace</span>(<span class="R">/_/g</span>, <span class="S">' '</span>);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">return</span> res<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + res.<span class="func">substr</span>(1);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.camelize = <span class="kwrd">function</span> (underscored, upcaseFirstLetter) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> res = <span class="S">''</span>;</code><span class="hits">3</span></li><li class=""><code>    underscored.<span class="func">split</span>(<span class="S">'_'</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (part) <span class="gly">{</span></code></li><li class="covered"><code>        res += part<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + part.<span class="func">substr</span>(1);</code><span class="hits">6</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">return</span> upcaseFirstLetter ? res : res<span class="gly">[</span>0<span class="gly">]</span>.toLower<span class="kwrd">Case</span>() + res.<span class="func">substr</span>(1);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.classify = <span class="kwrd">function</span> (str) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> exports.<span class="func">camelize</span>(exports.<span class="func">singularize</span>(str));</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.underscore = <span class="kwrd">function</span> (camelCaseStr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> initialUnderscore = camelCaseStr.<span class="func">match</span>(<span class="R">/^_/</span>) ? <span class="S">'_'</span> : <span class="S">''</span>;</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">var</span> str = camelCaseStr</code></li><li class=""><code>        .<span class="func">replace</span>(<span class="R">/^_([A-Z])/g</span>, <span class="S">'$1'</span>)</code></li><li class=""><code>        .<span class="func">replace</span>(<span class="R">/([A-Z])/g</span>, <span class="S">'_$1'</span>)</code></li><li class="covered"><code>        .<span class="func">replace</span>(<span class="R">/^_/</span>, initialUnderscore);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">return</span> str.toLower<span class="kwrd">Case</span>(); </code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.singularize = <span class="func">require</span>(<span class="S">'../vendor/inflection.js'</span>).singularize;</code><span class="hits">1</span></li><li class="covered"><code>exports.pluralize   = <span class="func">require</span>(<span class="S">'../vendor/inflection.js'</span>).pluralize;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// Stylize a string</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">stylize</span>(str, style) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> styles = <span class="gly">{</span></code></li><li class=""><code>        <span class="S">'bold'</span>      : <span class="gly">[</span>1,  22<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'italic'</span>    : <span class="gly">[</span>3,  23<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'underline'</span> : <span class="gly">[</span>4,  24<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'cyan'</span>      : <span class="gly">[</span>96, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'blue'</span>      : <span class="gly">[</span>34, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'yellow'</span>    : <span class="gly">[</span>33, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'green'</span>     : <span class="gly">[</span>32, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'red'</span>       : <span class="gly">[</span>31, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'grey'</span>      : <span class="gly">[</span>90, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'green-hi'</span>  : <span class="gly">[</span>92, 32<span class="gly">]</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">79</span></li><li class="covered"><code>    <span class="kwrd">var</span> s = styles<span class="gly">[</span>style<span class="gly">]</span>;</code><span class="hits">79</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'\033['</span> + s<span class="gly">[</span>0<span class="gly">]</span> + <span class="S">'m'</span> + str + <span class="S">'\033['</span> + s<span class="gly">[</span>1<span class="gly">]</span> + <span class="S">'m'</span>;</code><span class="hits">79</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> $ = <span class="kwrd">function</span> (str) <span class="gly">{</span></code></li><li class="covered"><code>    str = <span class="kwrd">new</span>(String)(str);</code><span class="hits">158</span></li><li class=""><code></code></li><li class=""><code>    <span class="gly">[</span><span class="S">'bold'</span>, <span class="S">'grey'</span>, <span class="S">'yellow'</span>, <span class="S">'red'</span>, <span class="S">'green'</span>, <span class="S">'cyan'</span>, <span class="S">'blue'</span>, <span class="S">'italic'</span>, <span class="S">'underline'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (style) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(str, style, <span class="gly">{</span></code></li><li class=""><code>            get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> <span class="func">$</span>(<span class="func">stylize</span>(this, style));</code><span class="hits">79</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1422</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">158</span></li><li class="covered"><code>    <span class="kwrd">return</span> str;</code><span class="hits">158</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>stylize.$ = $;</code><span class="hits">1</span></li><li class="covered"><code>exports.stylize = stylize;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.debug = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    railway.logger.<span class="func">write</span>(Array.prototype.jo<span class="kwrd">in</span>.<span class="func">call</span>(arguments, <span class="S">' '</span>));</code><span class="hits">42</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> addCoverage = exports.addCoverage = <span class="kwrd">function</span> (code, filename) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!global.__cov) <span class="kwrd">return</span> code;</code><span class="hits">15</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="func">require</span>(<span class="S">'semicov'</span>).<span class="func">addCoverage</span>(code, filename);</code><span class="hits">15</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// cache for source code</span></code></li><li class="covered"><code><span class="kwrd">var</span> cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="C">// cache for compiled scripts</span></code></li><li class="covered"><code><span class="kwrd">var</span> scriptCache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">runCode</span>(filename, context) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> isCoffee = filename.<span class="func">match</span>(<span class="R">/coffee$/</span>);</code><span class="hits">15</span></li><li class=""><code></code></li><li class="covered"><code>    context = context <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">15</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> dirname = path.<span class="func">dirname</span>(filename);</code><span class="hits">15</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// extend context</span></code></li><li class=""><code>    context.require = context.require <span class="gly">|</span><span class="gly">|</span> <span class="kwrd">function</span> (apath) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> isRelative = apath.<span class="func">match</span>(/^\.\.?\<span class="C">//);</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(isRelative ? path.<span class="func">resolve</span>(dirname, apath) : apath);</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">15</span></li><li class="covered"><code>    context.app = app;</code><span class="hits">15</span></li><li class="covered"><code>    context.railway = railway;</code><span class="hits">15</span></li><li class="covered"><code>    context.console = console;</code><span class="hits">15</span></li><li class="covered"><code>    context.setTimeout = setTimeout;</code><span class="hits">15</span></li><li class="covered"><code>    context.setInterval = setInterval;</code><span class="hits">15</span></li><li class="covered"><code>    context.clearTimeout = clearTimeout;</code><span class="hits">15</span></li><li class="covered"><code>    context.clearInterval = clearInterval;</code><span class="hits">15</span></li><li class="covered"><code>    context.__filename = filename;</code><span class="hits">15</span></li><li class="covered"><code>    context.__dirname = dirname;</code><span class="hits">15</span></li><li class="covered"><code>    context.process = process;</code><span class="hits">15</span></li><li class="covered"><code>    context.t = context.t <span class="gly">|</span><span class="gly">|</span> t;</code><span class="hits">15</span></li><li class="covered"><code>    context.Buffer = Buffer;</code><span class="hits">15</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// omit file reading and caching part if we have compiled script</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!scriptCache<span class="gly">[</span>filename<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>        cache<span class="gly">[</span>filename<span class="gly">]</span> = cache<span class="gly">[</span>filename<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> filename && path.<span class="func">existsSync</span>(filename) && <span class="func">require</span>(<span class="S">'fs'</span>).<span class="func">readFileSync</span>(filename);</code><span class="hits">15</span></li><li class=""><code>        <span class="kwrd">if</span> (!cache<span class="gly">[</span>filename<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> code = cache<span class="gly">[</span>filename<span class="gly">]</span>.<span class="func">toString</span>();</code><span class="hits">15</span></li><li class=""><code>        <span class="kwrd">if</span> (isCoffee) <span class="gly">{</span></code></li><li class=""><code>            try <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> cs = <span class="func">require</span>(<span class="S">'coffee-script'</span>);</code></li><li class=""><code>            <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>                throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Please install coffee-script npm package: `npm install coffee-script`'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            try <span class="gly">{</span></code></li><li class="uncovered"><code>                code = <span class="func">require</span>(<span class="S">'coffee-script'</span>).<span class="func">compile</span>(code);</code></li><li class=""><code>            <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>                console.<span class="func">log</span>(<span class="S">'Error in coffee code compilation in file '</span> + filename);</code></li><li class="uncovered"><code>                throw e;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            code = <span class="func">addCoverage</span>(code, filename);</code><span class="hits">15</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> m;</code><span class="hits">15</span></li><li class=""><code>        <span class="kwrd">if</span> (scriptCache<span class="gly">[</span>filename<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            m = scriptCache<span class="gly">[</span>filename<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            m = vm.<span class="func">createScript</span>(code.<span class="func">toString</span>(<span class="S">'utf8'</span>), filename);</code><span class="hits">15</span></li><li class="covered"><code>            scriptCache<span class="gly">[</span>filename<span class="gly">]</span> = m;</code><span class="hits">15</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        m.<span class="func">runInNewContext</span>(context);</code><span class="hits">15</span></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'Error while executing '</span> + filename);</code></li><li class="uncovered"><code>        throw e;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// disable caching in development mode</span></code></li><li class=""><code>    <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'eval cache'</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        cache<span class="gly">[</span>filename<span class="gly">]</span> = null;</code><span class="hits">15</span></li><li class="covered"><code>        scriptCache<span class="gly">[</span>filename<span class="gly">]</span> = null;</code><span class="hits">15</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.runCode = runCode;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addSpaces</span>(str, len, to_start) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> str_len = str.length;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i = str_len; i < len; i += 1) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!to_start) <span class="gly">{</span></code></li><li class="covered"><code>            str += <span class="S">' '</span>;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            str = <span class="S">' '</span> + str;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> str;</code><span class="hits">2</span></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.addSpaces = addSpaces;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">readYaml</span>(file) <span class="gly">{</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(<span class="S">'yaml'</span>).<span class="func">eval</span>(fs.<span class="func">readFileSync</span>(file).<span class="func">toString</span>());</code></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'Error in reading'</span>, file);</code></li><li class="uncovered"><code>        console.<span class="func">log</span>(e.message);</code></li><li class="uncovered"><code>        console.<span class="func">log</span>(e.stack);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.readYaml = readYaml;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-tools-js" class="filename" name="lib-tools-js" onclick="var el = document.getElementById('lib-tools-js'); el.style.display = el.style.display ? '' : 'none';">lib/tools.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 16%"><strong>16%</strong> [86/270]</div></div></div></div><div id="lib-tools-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> readline = <span class="func">require</span>(<span class="S">'readline'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> childProcess = <span class="func">require</span>(<span class="S">'child_process'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> sys = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> util = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Print routing map. Optionally accepts `filter` param, allowing to filter</span></code></li><li class=""><code><span class="C"> * output by method or helper name</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param filter</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway routes</span></code></li><li class=""><code><span class="C"> *  projects GET    /projects           projects#index</span></code></li><li class=""><code><span class="C"> *    update ALL    /:user/:repo/update doc#update</span></code></li><li class=""><code><span class="C"> *           GET    /:user/:repo        doc#make</span></code></li><li class=""><code><span class="C"> *         * GET    /:user/:repo/*      doc#make</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * same but filtered to show GET routes only</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway routes get</span></code></li><li class=""><code><span class="C"> *  projects GET    /projects           projects#index</span></code></li><li class=""><code><span class="C"> *           GET    /:user/:repo        doc#make</span></code></li><li class=""><code><span class="C"> *         * GET    /:user/:repo/*      doc#make</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * same but filtered to show routes with helper name contains `pro`</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway routes get</span></code></li><li class=""><code><span class="C"> *  projects GET    /projects           projects#index</span></code></li><li class=""><code><span class="C"> w ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">routes</span>() <span class="gly">{</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> mapper = railway.routeMapper;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> addSpaces = railway.utils.addSpaces;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> dump = mapper.dump;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> max_len = 0, helper_max_len = 0;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> filter = (args.<span class="func">shift</span>() <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>).toUpper<span class="kwrd">Case</span>();</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> filtered = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>    dump.<span class="func">forEach</span>(<span class="kwrd">function</span> (data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> method = data.method.toUpper<span class="kwrd">Case</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (!filter <span class="gly">|</span><span class="gly">|</span> filter === method <span class="gly">|</span><span class="gly">|</span> data.helper.toUpper<span class="kwrd">Case</span>().<span class="func">search</span>(filter) !== -1) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (data.path.length > max_len) <span class="gly">{</span></code></li><li class="uncovered"><code>                max_len = data.path.length;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (data.helper.length > helper_max_len) <span class="gly">{</span></code></li><li class="uncovered"><code>                helper_max_len = data.helper.length;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            filtered.<span class="func">push</span>(data);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    filtered.<span class="func">forEach</span>(<span class="kwrd">function</span> (data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> method = data.method.toUpper<span class="kwrd">Case</span>();</code></li><li class=""><code>        console.<span class="func">log</span>(</code></li><li class=""><code>            <span class="func">addSpaces</span>(data.helper, helper_max_len + 1, true) + <span class="S">' '</span> +</code></li><li class=""><code>            <span class="func">addSpaces</span>(method, 7) +</code></li><li class=""><code>            <span class="func">addSpaces</span>(data.path, max_len + 1) +</code></li><li class=""><code>            data.file + <span class="S">"#"</span> + data.action</code></li><li class="uncovered"><code>        );</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> true;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.routes = routes;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>routes.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut:    <span class="S">'r'</span>,</code></li><li class=""><code>    usage:       <span class="S">'routes [filter]'</span>,</code></li><li class=""><code>    description: <span class="S">'Display application routes'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Debug console.</span></code></li><li class=""><code><span class="C"> * node REPL console with railway bindings</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Predefined helpers:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *  - `c` - callback, assigning it's arguments to _0 _1 .. _N variables</span></code></li><li class=""><code><span class="C"> *  - `reload` - reload models</span></code></li><li class=""><code><span class="C"> *  - `exit` - quit repl</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Usage Example:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway console</span></code></li><li class=""><code><span class="C"> * railway> User.all(c)</span></code></li><li class=""><code><span class="C"> * undefined</span></code></li><li class=""><code><span class="C"> * railway> [ [ 'hgetall', 'User:68' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:69' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:70' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:71' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:72' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:73' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:74' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:75' ] ] '[2ms]'</span></code></li><li class=""><code><span class="C"> *  Callback called with 2 arguments:</span></code></li><li class=""><code><span class="C"> *  _0 = null</span></code></li><li class=""><code><span class="C"> *  _1 = [object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object]</span></code></li><li class=""><code><span class="C"> * railway> _1[0].toObject()</span></code></li><li class=""><code><span class="C"> * { id: '68',</span></code></li><li class=""><code><span class="C"> *   githubId: null,</span></code></li><li class=""><code><span class="C"> *   displayName: null,</span></code></li><li class=""><code><span class="C"> *   username: null,</span></code></li><li class=""><code><span class="C"> *   avatar: null }</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">railwayConsole</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> ctx = <span class="func">require</span>(<span class="S">'repl'</span>).<span class="func">start</span>(<span class="S">'railway> '</span>).context;</code></li><li class=""><code></code></li><li class=""><code>    ctx.reload = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        global.models = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>        ctx.app = app;</code></li><li class="uncovered"><code>        app.<span class="func">reloadModels</span>();</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> m <span class="kwrd">in</span> models) <span class="gly">{</span></code></li><li class="uncovered"><code>            ctx<span class="gly">[</span>m<span class="gly">]</span> = models<span class="gly">[</span>m<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    ctx.c = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> l = arguments.length,</code></li><li class=""><code>            message = <span class="S">'Callback called with '</span> + l +</code></li><li class="uncovered"><code>                <span class="S">' argument'</span> + (l === 1 ? <span class="S">''</span> : <span class="S">'s'</span>) + (l > 0 ? <span class="S">':\n'</span> : <span class="S">''</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i < 10; i++) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (i < arguments.length) <span class="gly">{</span></code></li><li class="uncovered"><code>                ctx<span class="gly">[</span><span class="S">'_'</span> + i<span class="gly">]</span> = arguments<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class="uncovered"><code>                message += <span class="S">'_'</span> + i + <span class="S">' = '</span> + arguments<span class="gly">[</span>i<span class="gly">]</span> + <span class="S">'\n'</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (ctx.<span class="func">hasOwnProperty</span>(<span class="S">'_'</span> + i)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    delete ctx<span class="gly">[</span><span class="S">'_'</span> + i<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(message);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    ctx.exit = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        process.<span class="func">exit</span>(0);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>    process.<span class="func">nextTick</span>(ctx.reload);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> false;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.console = railwayConsole;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>railwayConsole.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut:    <span class="S">'c'</span>,</code></li><li class=""><code>    usage:       <span class="S">'console'</span>,</code></li><li class=""><code>    description: <span class="S">'Debug console'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code>exports.dbconsole = <span class="kwrd">function</span> <span class="func">dbconsole</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> db = childProcess.<span class="func">spawn</span>(<span class="S">'mongo'</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> rli = readline.<span class="func">createInterface</span>(process.std<span class="kwrd">in</span>, process.stdout, autocomplete);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> data = <span class="S">''</span>;</code></li><li class=""><code>    db.stdout.<span class="func">on</span>(<span class="S">'data'</span>, <span class="kwrd">function</span> (chunk) <span class="gly">{</span></code></li><li class="uncovered"><code>        data += chunk;</code></li><li class="uncovered"><code>        <span class="func">write</span>();</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">write</span>() <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (write.to) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">clearTimeout</span>(write.to);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="func">setTimeout</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>            process.stdout.<span class="func">write</span>(data);</code></li><li class="uncovered"><code>            rli.<span class="func">prompt</span>();</code></li><li class="uncovered"><code>            data = <span class="S">''</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>, 50);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    rli.<span class="func">on</span>(<span class="S">'SIGINT'</span>, rli.close.<span class="func">bind</span>(rli));</code></li><li class="uncovered"><code>    rli.<span class="func">addListener</span>(<span class="S">'close'</span>, process.exit);</code></li><li class="uncovered"><code>    rli.<span class="func">setPrompt</span>(<span class="S">'mongo > '</span>);</code></li><li class=""><code>    rli.<span class="func">addListener</span>(<span class="S">'line'</span>, <span class="kwrd">function</span> (line) <span class="gly">{</span></code></li><li class="uncovered"><code>        db.std<span class="kwrd">in</span>.<span class="func">write</span>(line + <span class="S">'\n'</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="C">// console.log(db);</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">autocomplete</span>(input) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="gly">[</span><span class="gly">[</span><span class="S">'help'</span>, <span class="S">'test'</span><span class="gly">]</span>, input<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Railway server. Command optionally accept PORT argument</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * railway server 8000  # run server on 8000 port</span></code></li><li class=""><code><span class="C"> * railway s 3000       # run server on 3000 port using shorter alias</span></code></li><li class=""><code><span class="C"> * PORT=80 railway s    # run server on 80 port usin env var PORT</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">server</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> port = process.env.PORT <span class="gly">|</span><span class="gly">|</span> args.<span class="func">shift</span>() <span class="gly">|</span><span class="gly">|</span> 3000;</code></li><li class="uncovered"><code>    app.<span class="func">listen</span>(port);</code></li><li class="uncovered"><code>    console.<span class="func">log</span>(<span class="S">"Railway server listening on port %d within %s environment"</span>, port, app.settings.env);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> false;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.server = server;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>server.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut: <span class="S">'s'</span>,</code></li><li class=""><code>    usage: <span class="S">'server [port]'</span>,</code></li><li class=""><code>    description: <span class="S">'Run railway server'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Install railway extension</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">install</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> what = args.<span class="func">shift</span>(), where = args.<span class="func">shift</span>();</code></li><li class=""><code>    <span class="kwrd">if</span> (!what <span class="gly">|</span><span class="gly">|</span> !what.<span class="func">match</span>(<span class="R">/\.git$/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'What do you want to install?'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> true;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!where) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> m = what.<span class="func">match</span>(<span class="R">/\/([^\/]*?)\.git/</span>);</code></li><li class="uncovered"><code>        where = m<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!path.<span class="func">existsSync</span>(app.root + <span class="S">'/node_modules'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        fs.<span class="func">mkdirSync</span>(app.root + <span class="S">'/node_modules'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> command = <span class="S">'clone'</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(app.root + <span class="S">'/.git'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        command = <span class="S">'submodule add'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    console.<span class="func">log</span>(<span class="S">'Installing '</span> + where + <span class="S">' extension from '</span> + what + <span class="S">' repo to node_modules/'</span> + where);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> cp = <span class="func">require</span>(<span class="S">'child_process'</span>);</code></li><li class=""><code>    cp.<span class="func">exec</span>(<span class="S">'git '</span> + command + <span class="S">' '</span> + what + <span class="S">' node_modules/'</span> + where, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(app.root + <span class="S">'/npmfile.coffee'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            cp.<span class="func">exec</span>(<span class="S">'echo "require \''</span> + where + <span class="S">'\'" >> npmfile.coffee'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Patched npmfile.coffee'</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            cp.<span class="func">exec</span>(<span class="S">'echo "require(\''</span> + where + <span class="S">'\');" >> npmfile.js'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Patched npmfile.js'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> installScript = app.root + <span class="S">'/node_modules/'</span> + where + <span class="S">'/install.js'</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(installScript)) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Running installation script'</span>);</code></li><li class="uncovered"><code>            <span class="func">require</span>(installScript);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            process.<span class="func">exit</span>(0);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> false;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.install = install;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>install.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut: <span class="S">'x'</span>,</code></li><li class=""><code>    usage: <span class="S">'install gitUrl [extName]'</span>,</code></li><li class=""><code>    description: <span class="S">'Install railway eXtension'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-onrailway-js" class="filename" name="lib-onrailway-js" onclick="var el = document.getElementById('lib-onrailway-js'); el.style.display = el.style.display ? '' : 'none';">lib/onrailway.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 70%"><strong>70%</strong> [71/242]</div></div></div></div><div id="lib-onrailway-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> singularize = <span class="func">require</span>(<span class="S">"../vendor/inflection"</span>).singularize;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> safe_merge = utils.safe_merge;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Map = <span class="func">require</span>(<span class="S">'railway-routes'</span>).Map;</code><span class="hits">1</span></li><li class="covered"><code><span class="func">require</span>(<span class="S">'coffee-script'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Global railway API singleton.</span></code></li><li class=""><code><span class="C"> * Available everywhere in project.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @member railway.locales - localization module</span></code></li><li class=""><code><span class="C"> * @member railway.utils - railway utilities (stylize, runCode, etc..)</span></code></li><li class=""><code><span class="C"> * @see railway_utils.html#</span></code></li><li class=""><code><span class="C"> * @member railway.controller</span></code></li><li class=""><code><span class="C"> * @see controller.html#</span></code></li><li class=""><code><span class="C"> * @member railway.extensions</span></code></li><li class=""><code><span class="C"> * @see extensions.html#</span></code></li><li class=""><code><span class="C"> * @member railway.generators</span></code></li><li class=""><code><span class="C"> * @see generators.html#</span></code></li><li class=""><code><span class="C"> * @member railway.tools</span></code></li><li class=""><code><span class="C"> * @see tools.html#</span></code></li><li class=""><code><span class="C"> * @member railway.logger</span></code></li><li class=""><code><span class="C"> * @see logger.html#</span></code></li><li class=""><code><span class="C"> * @member railway.helpers</span></code></li><li class=""><code><span class="C"> * @see helpers.html#</span></code></li><li class=""><code><span class="C"> * @member railway.models</span></code></li><li class=""><code><span class="C"> * @see model.html#</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Railway</span>() <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>    global.railway = this;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    this.locales     = <span class="func">require</span>(<span class="S">'./locales'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.utils       = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    this.ControllerBridge = <span class="func">require</span>(<span class="S">'./controller_bridge'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    this.controller  = <span class="func">require</span>(<span class="S">'./controller'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.extensions  = <span class="func">require</span>(<span class="S">'./extensions'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.generators  = <span class="func">require</span>(<span class="S">'./generators'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.tools       = <span class="func">require</span>(<span class="S">'./tools'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.logger      = <span class="func">require</span>(<span class="S">'./logger'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.routeMapper = <span class="kwrd">new</span> <span class="func">Map</span>(app, this.ControllerBridge.uniCaller);</code><span class="hits">1</span></li><li class="covered"><code>    this.helpers     = <span class="func">require</span>(<span class="S">'./helpers'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    this.models      = <span class="func">require</span>(<span class="S">'./models'</span>);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>try <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (process.versions.node < <span class="S">'0.6'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        Railway.prototype.version = JSON.<span class="func">parse</span>(fs.<span class="func">readFileSync</span>(__dirname + <span class="S">'/../package.json'</span>)).version;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        Railway.prototype.version = <span class="func">require</span>(<span class="S">'../package'</span>).version;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize railway application:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *  - load modules</span></code></li><li class=""><code><span class="C"> *  - run configurators (config/environment, config/environments/{env})</span></code></li><li class=""><code><span class="C"> *  - init controllers</span></code></li><li class=""><code><span class="C"> *  - init extensions (including ORM and db/schema)</span></code></li><li class=""><code><span class="C"> *  - init models</span></code></li><li class=""><code><span class="C"> *  - run initializers `config/initializers/*`</span></code></li><li class=""><code><span class="C"> *  - add routes</span></code></li><li class=""><code><span class="C"> *  - start http server</span></code></li><li class=""><code><span class="C"> *  - locales</span></code></li><li class=""><code><span class="C"> *  - loggers</span></code></li><li class=""><code><span class="C"> *  - observers</span></code></li><li class=""><code><span class="C"> *  - assets</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> <span class="func">initRailway</span>(app) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (arguments.length == 2) <span class="gly">{</span></code></li><li class="uncovered"><code>        app = arguments<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// globalize app object</span></code></li><li class="covered"><code>    global.app = app;</code><span class="hits">1</span></li><li class="covered"><code>    app.root = process.<span class="func">cwd</span>();</code><span class="hits">1</span></li><li class="covered"><code>    app.models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// create API publishing object</span></code></li><li class="covered"><code>    <span class="kwrd">new</span> <span class="func">Railway</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// run environment.{js|coffee} and environments/{test|development|production}.{js|coffee}</span></code></li><li class="covered"><code>    <span class="func">configureApp</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// controllers should be loaded before extensions</span></code></li><li class="covered"><code>    railway.controller.<span class="func">init</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="C">// extensions should be loaded before server startup</span></code></li><li class="covered"><code>    railway.extensions.<span class="func">init</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    railway.models.<span class="func">init</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// run config/initializers~~~C2~~~</span></code></li><li class="covered"><code>exports.createServer = <span class="kwrd">function</span> (options) <span class="gly">{</span></code><span class="hits">1</span></li><li class="uncovered"><code>    options = options <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">var</span> keys, app,</code></li><li class=""><code>        key = options.key <span class="gly">|</span><span class="gly">|</span> process.<span class="func">cwd</span>() + <span class="S">'/config/tsl.key'</span>,</code></li><li class="uncovered"><code>        cert = options.cert <span class="gly">|</span><span class="gly">|</span> process.<span class="func">cwd</span>() + <span class="S">'/config/tsl.cert'</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(key) && path.<span class="func">existsSync</span>(cert)) <span class="gly">{</span></code></li><li class="covered"><code>        keys = <span class="gly">{</span></code><span class="hits">1</span></li><li class="covered"><code>            key: fs.<span class="func">readFileSync</span>(key).<span class="func">toString</span>(<span class="S">'utf8'</span>),</code><span class="hits">1</span></li><li class="covered"><code>            cert: fs.<span class="func">readFileSync</span>(cert).<span class="func">toString</span>(<span class="S">'utf8'</span>)</code><span class="hits">1</span></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="covered"><code>    <span class="gly">}</span></code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (keys) <span class="gly">{</span></code></li><li class="uncovered"><code>        app = <span class="func">require</span>(<span class="S">'express'</span>).<span class="func">createServer</span>(keys);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        app = <span class="func">require</span>(<span class="S">'express'</span>).<span class="func">createServer</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    exports.<span class="func">init</span>(app);</code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> app;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Run app configutators in `config/environment` and `config/environments/{env}`.</span></code></li><li class=""><code><span class="C"> * Also try to monkey patch ejs and jade. **weird**</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">configureApp</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> mainEnv = app.root + <span class="S">'/config/environment'</span>;</code></li><li class="uncovered"><code>    <span class="func">requireIfExists</span>(mainEnv + <span class="S">'.js'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="func">requireIfExists</span>(mainEnv + <span class="S">'.coffee'</span>);</code></li><li class="covered"><code>    <span class="kwrd">var</span> supportEnv = app.root + <span class="S">'/config/environments/'</span> + app.settings.env;</code><span class="hits">1</span></li><li class="uncovered"><code>    <span class="func">requireIfExists</span>(supportEnv + <span class="S">'.js'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="func">requireIfExists</span>(supportEnv + <span class="S">'.coffee'</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span> == <span class="S">'ejs'</span> && (!app.extensions <span class="gly">|</span><span class="gly">|</span> !app.extensions<span class="gly">[</span><span class="S">'ejs-ext'</span><span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="C">// monkey patch ejs</span></code><span class="hits">1</span></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> ejs = <span class="func">require</span>(<span class="S">'ejs'</span>), old_parse = ejs.parse;</code></li><li class=""><code>            ejs.parse = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> str = old_parse.<span class="func">apply</span>(this, Array.prototype.slice.<span class="func">call</span>(arguments));</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> str.<span class="func">replace</span>(<span class="S">'var buf = [];'</span>, <span class="S">'var buf = []; arguments.callee.buf = buf;'</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span> == <span class="S">'jade'</span> && (!app.extensions <span class="gly">|</span><span class="gly">|</span> !app.extensions<span class="gly">[</span><span class="S">'jade-ext'</span><span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// monkey patch jade</span></code></li><li class="covered"><code>        try <span class="gly">{</span></code><span class="hits">1</span></li><li class="uncovered"><code>            <span class="kwrd">var</span> jade = <span class="func">require</span>(<span class="S">'jade'</span>), old_parse = jade.Compiler.prototype.compile;</code></li><li class=""><code>            jade.Compiler.prototype.compile = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> str = old_parse.<span class="func">apply</span>(this, Array.prototype.slice.<span class="func">call</span>(arguments));</code><span class="hits">1</span></li><li class=""><code>                <span class="C">// console.log(str);</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> <span class="S">'arguments.callee.buf = buf;'</span> + str;</code><span class="hits">1</span></li><li class="covered"><code>            <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class="covered"><code><span class="C"> * Require `module` if it exists</span></code><span class="hits">1</span></li><li class="covered"><code><span class="C"> *</span></code><span class="hits">1</span></li><li class="covered"><code><span class="C"> * @param {String} module - path to file</span></code><span class="hits">1</span></li><li class="covered"><code><span class="C"> */</span></code><span class="hits">1</span></li><li class=""><code><span class="kwrd">function</span> <span class="func">requireIfExists</span>(module) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(module)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">require</span>(module);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> true;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> false;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Run initializers in sandbox mode</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">runInitializers</span>() <span class="gly">{</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> context = <span class="gly">{</span>global: <span class="gly">{</span><span class="gly">}</span><span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> app.models) <span class="gly">{</span></code></li><li class="uncovered"><code>        context<span class="gly">[</span>i<span class="gly">]</span> = app.models<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> initializersPath = app.root + <span class="S">'/config/initializers/'</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">require</span>(<span class="S">'path'</span>).<span class="func">existsSync</span>(initializersPath)) <span class="gly">{</span></code></li><li class=""><code>        fs.<span class="func">readdirSync</span>(initializersPath).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/^\./</span>)) <span class="kwrd">return</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> script_name = initializersPath + file;</code></li><li class="uncovered"><code>            utils.<span class="func">runCode</span>(script_name, context);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> context.global) <span class="gly">{</span></code></li><li class="uncovered"><code>            global<span class="gly">[</span>i<span class="gly">]</span> = context.global<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Observer is a kind of controller, that listen for some event in </span></code></li><li class=""><code><span class="C"> * the system, for example: paypal, twitter or facebook observers </span></code></li><li class="covered"><code><span class="C"> * listens for callback from foreign service. Email observer may </span></code><span class="hits">4</span></li><li class=""><code><span class="C"> * listen some events related to emails.</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * If you need app.on('someEvent') you should place this code in</span></code></li><li class=""><code><span class="C"> * APPROOT/app/observers/NAME_observer.js</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">loadObservers</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> dir = app.root + <span class="S">'/app/observers'</span>;</code></li><li class=""><code>    path.<span class="func">exists</span>(dir, <span class="kwrd">function</span> (exists) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (exists) <span class="gly">{</span></code><span class="hits">1</span></li><li class=""><code>            fs.<span class="func">readdir</span>(dir, <span class="kwrd">function</span> (err, files) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!err && files) <span class="gly">{</span></code></li><li class=""><code>                    files.<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/^[^\.]/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                            <span class="func">require</span>(path.jo<span class="kwrd">in</span>(dir, file));</code></li><li class="covered"><code>                        <span class="gly">}</span></code><span class="hits">1</span></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Cleanup or create dir</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">ensureDirClean</span>(dir) <span class="gly">{</span></code></li><li class=""><code>    path.<span class="func">exists</span>(dir, <span class="kwrd">function</span> (exists) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (exists) <span class="gly">{</span></code></li><li class=""><code>            fs.<span class="func">readdir</span>(dir, <span class="kwrd">function</span> (err, files) <span class="gly">{</span></code></li><li class=""><code>                files.<span class="func">map</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> path.jo<span class="kwrd">in</span>(dir, file);</code></li><li class="uncovered"><code>                <span class="gly">}</span>).<span class="func">forEach</span>(fs.unlink);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            fs.<span class="func">mkdir</span>(dir, 0755);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span></code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-locales-js" class="filename" name="lib-locales-js" onclick="var el = document.getElementById('lib-locales-js'); el.style.display = el.style.display ? '' : 'none';">lib/locales.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 25%"><strong>25%</strong> [48/144]</div></div></div></div><div id="lib-locales-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    yaml = <span class="func">require</span>(<span class="S">'yaml'</span>),</code></li><li class=""><code>    coffee = <span class="func">require</span>(<span class="S">'coffee-script'</span>),</code></li><li class=""><code>    path = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class="covered"><code>    localeData = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize localization module</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> dir = app.root + <span class="S">'/config/locales'</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (!path.<span class="func">existsSync</span>(dir)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> false;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    app.locales = app.locales <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>    exports.<span class="func">load</span>(dir);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Load localization files from `dir`. Locales can be in yaml, json or coffee</span></code></li><li class=""><code><span class="C"> * format</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example locale.yml file:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *    en:</span></code></li><li class=""><code><span class="C"> *      key: 'Value'</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} dir - absolute path to locales directory</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.load = <span class="kwrd">function</span> (dir) <span class="gly">{</span></code></li><li class=""><code>    fs.<span class="func">readdirSync</span>(dir).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/^\./</span>)) <span class="kwrd">return</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> filename = dir + <span class="S">'/'</span> + file;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> code = fs.<span class="func">readFileSync</span>(filename, <span class="S">'utf8'</span>).<span class="func">toString</span>();</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> obj;</code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/\.ya?ml$/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = yaml.<span class="func">eval</span>(code.<span class="func">replace</span>(<span class="R">/\r\n?/g</span>,<span class="S">'\n'</span>));</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/\.json/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = JSON.<span class="func">parse</span>(code);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/\.coffee/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = coffee.<span class="func">eval</span>(code);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                console.<span class="func">log</span>(<span class="S">'Unsupported extension of locale file '</span> + filename);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Parsing file '</span> + filename);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(e);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(e.stack);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (obj) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">addTranslation</span>(obj);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add translation to `lang` to application locales collection</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addTranslation</span>(lang) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(lang).<span class="func">forEach</span>(<span class="kwrd">function</span> (localeName) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> translations = lang<span class="gly">[</span>localeName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (app.locales.<span class="func">indexOf</span>(localeName) === -1) <span class="gly">{</span></code></li><li class="uncovered"><code>            app.locales.<span class="func">push</span>(<span class="gly">[</span>localeName, translations.lang && translations.lang.name <span class="gly">|</span><span class="gly">|</span> localeName<span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        localeData<span class="gly">[</span>localeName<span class="gly">]</span> = localeData<span class="gly">[</span>localeName<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        Object.<span class="func">keys</span>(translations).<span class="func">forEach</span>(<span class="kwrd">function</span> (namespace) <span class="gly">{</span></code></li><li class="uncovered"><code>            localeData<span class="gly">[</span>localeName<span class="gly">]</span><span class="gly">[</span>namespace<span class="gly">]</span> = translations<span class="gly">[</span>namespace<span class="gly">]</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Global translation helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Boolean} global</span></code></li><li class=""><code><span class="C"> * @public</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">T</span>(global) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (global) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// helper for global scope (models, initializers, etc)</span></code></li><li class=""><code>        <span class="C">// requires two params (locale expected)</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="kwrd">function</span> <span class="func">t</span>(path, locale, defaultValue) <span class="gly">{</span></code><span class="hits">1</span></li><li class=""><code>            <span class="kwrd">if</span> (!locale) <span class="gly">{</span></code></li><li class="uncovered"><code>                throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Locale expected'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">translate</span>(path, locale);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// helper for local scope (controllers, views, helpers)</span></code></li><li class=""><code>        <span class="C">// requires one param</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="kwrd">function</span> <span class="func">t</span>(path, defaultValue) <span class="gly">{</span></code><span class="hits">11</span></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">translate</span>(path, t.locale, defaultValue);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">translate</span>(path, locale, defaultValue) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> translation = localeData<span class="gly">[</span>locale<span class="gly">]</span>, substitute;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">nextPathItem</span>(token) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> (translation = translation<span class="gly">[</span>token<span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> path === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            substitute = false;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            substitute = path;</code></li><li class="uncovered"><code>            path = substitute.<span class="func">shift</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!translation <span class="gly">|</span><span class="gly">|</span> !path.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">every</span>(nextPathItem)) <span class="gly">{</span></code></li><li class="uncovered"><code>            translation = defaultValue <span class="gly">|</span><span class="gly">|</span> <span class="func">translationMissing</span>(locale, path);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (translation && substitute && substitute.length) <span class="gly">{</span></code></li><li class=""><code>            substitute.<span class="func">forEach</span>(<span class="kwrd">function</span> (substitution) <span class="gly">{</span></code></li><li class="uncovered"><code>                translation = translation.<span class="func">replace</span>(<span class="R">/%/</span>, substitution.<span class="func">toString</span>().<span class="func">replace</span>(<span class="R">/%/g</span>, <span class="S">''</span>));</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> translation;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">translationMissing</span>(locale, path) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">switch</span> (app.settings.translationMissing) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'display'</span>:</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="S">'translation missing for '</span> + locale + <span class="S">'.'</span> + path;</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'default'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> undefined:</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> defLocale = app.settings.defaultLocale;</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> !defLocale <span class="gly">|</span><span class="gly">|</span> locale === defLocale ? <span class="S">''</span> : <span class="func">translate</span>(path, defLocale);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>T.localeSupported = <span class="kwrd">function</span> (localeName) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> !!localeData<span class="gly">[</span>localeName<span class="gly">]</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>global.t = <span class="func">T</span>(true);</code><span class="hits">1</span></li><li class="covered"><code>global.T = T;</code><span class="hits">1</span></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-extensions-js" class="filename" name="lib-extensions-js" onclick="var el = document.getElementById('lib-extensions-js'); el.style.display = el.style.display ? '' : 'none';">lib/extensions.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 57%"><strong>57%</strong> [28/101]</div></div></div></div><div id="lib-extensions-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./railway_utils'</span>),</code></li><li class="covered"><code>    path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>app.extensions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize extensions (using npmfile)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    app.extensions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> ctx = <span class="func">getNPMFileContext</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">var</span> root = app.root + <span class="S">'/'</span>,</code></li><li class=""><code>        js = <span class="S">'npmfile.js'</span>, coffee = <span class="S">'npmfile.coffee'</span>,</code></li><li class="covered"><code>        filename;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(root + js)) <span class="gly">{</span></code></li><li class="uncovered"><code>        filename = js;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(root + coffee)) <span class="gly">{</span></code></li><li class="uncovered"><code>        filename = coffee;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filename) <span class="gly">{</span></code></li><li class="uncovered"><code>        utils.<span class="func">runCode</span>(filename, ctx);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">initBundledExtensions</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Prepare context for executing npm file. Context has two additional features:</span></code></li><li class=""><code><span class="C"> * - group</span></code></li><li class=""><code><span class="C"> * - improved require (run init method of module)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getNPMFileContext</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ctx = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    ctx.require = <span class="kwrd">function</span> (package) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ext = app.extensions<span class="gly">[</span>package<span class="gly">]</span> = <span class="func">require</span>(package);</code></li><li class=""><code>        <span class="kwrd">if</span> (ext && ext.init) <span class="gly">{</span></code></li><li class="uncovered"><code>            ext.<span class="func">init</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    ctx.group = <span class="kwrd">function</span> (env, callback) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (env == app.settings.env) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> ctx;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">initBundledExtensions</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">envInfo</span>();</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Setup route /railway/environment.json to return information about environment</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">envInfo</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> jugglingdbVersion, npmVersion;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    app.<span class="func">all</span>(<span class="S">'/railway/environment.json'</span>, <span class="kwrd">function</span> (req, res) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> jugglingdbVersion = <span class="func">require</span>(<span class="S">'jugglingdb'</span>).version;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> npmVersion = <span class="func">require</span>(<span class="S">'npm'</span>).version;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> viewEngineVersion = <span class="func">require</span>(app.root + <span class="S">'/node_modules/'</span> +  app.<span class="func">set</span>(<span class="S">'view engine'</span>)).version;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            viewEngineVersion = <span class="S">'not installed'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'env info'</span>)) <span class="kwrd">return</span> res.<span class="func">send</span>(<span class="gly">{</span>forbidden: true<span class="gly">}</span>);</code></li><li class=""><code>        res.<span class="func">send</span>(<span class="gly">{</span></code></li><li class=""><code>            settings: app.settings,</code></li><li class=""><code>            versions: <span class="gly">{</span></code></li><li class=""><code>                core: process.versions,</code></li><li class=""><code>                npm: npmVersion,</code></li><li class=""><code>                railway: railway.version,</code></li><li class=""><code>                jugglingdb: jugglingdbVersion,</code></li><li class=""><code>                templating: <span class="gly">{</span></code></li><li class=""><code>                    name: app.<span class="func">set</span>(<span class="S">'view engine'</span>),</code></li><li class=""><code>                    version: viewEngineVersion</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            application: <span class="gly">{</span></code></li><li class=""><code>                root: app.root,</code></li><li class=""><code>                database: <span class="func">require</span>(app.root + <span class="S">'/config/database'</span>)<span class="gly">[</span>app.<span class="func">set</span>(<span class="S">'env'</span>)<span class="gly">]</span>.driver,</code></li><li class=""><code>                middleware: app.stack.<span class="func">map</span>(<span class="kwrd">function</span> (m) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> m.handle.name;</code></li><li class=""><code>                <span class="gly">}</span>)</code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            env: process.env,</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-models-js" class="filename" name="lib-models-js" onclick="var el = document.getElementById('lib-models-js'); el.style.display = el.style.display ? '' : 'none';">lib/models.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 38%"><strong>38%</strong> [26/68]</div></div></div></div><div id="lib-models-js" style="display:none;"><pre><ol><li class="covered"><code><span class="C">// Deps</span></code></li><li class=""><code><span class="kwrd">var</span> fs          = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    path        = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    Module      = <span class="func">require</span>(<span class="S">'module'</span>),</code></li><li class="covered"><code>    utils       = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize models</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// code coverage support</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (process.cov) context.__cov = __cov;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// quietly fallback to default schema</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (!railway.orm) <span class="func">require</span>(<span class="S">'jugglingdb'</span>).<span class="func">init</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// then run models</span></code></li><li class="covered"><code>    exports.<span class="func">loadModels</span>(app.root + <span class="S">'/app/models/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>global.publish = <span class="kwrd">function</span> (name, model) <span class="gly">{</span></code></li><li class="uncovered"><code>    console.<span class="func">log</span>(<span class="S">'WARNING: `publish` call inside model files deprecated now, use module.exports = MyModel in case of declaring new model in app/models/*.js file, and not in db/schema.js'</span>);</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> name === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        model = name;</code></li><li class="uncovered"><code>        name = model.name;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    app.models<span class="gly">[</span>name<span class="gly">]</span> = model;</code></li><li class="uncovered"><code>    global<span class="gly">[</span>name<span class="gly">]</span> = model;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.loadModels = <span class="kwrd">function</span> (modelsDir) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ctx = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(app.models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="uncovered"><code>        ctx<span class="gly">[</span>model<span class="gly">]</span> = app.models<span class="gly">[</span>model<span class="gly">]</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (ctx<span class="gly">[</span>model<span class="gly">]</span>._validations) delete ctx<span class="gly">[</span>model<span class="gly">]</span>._validations;</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(modelsDir)) <span class="gly">{</span></code></li><li class=""><code>        fs.<span class="func">readdirSync</span>(modelsDir).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (file.<span class="func">match</span>(<span class="R">/^[^\.].*?\.(js|coffee)$/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> filename = path.jo<span class="kwrd">in</span>(modelsDir, file);</code></li><li class="uncovered"><code>                delete Module._cache<span class="gly">[</span>filename<span class="gly">]</span>;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> m = <span class="func">require</span>(filename);</code></li><li class=""><code>                <span class="kwrd">if</span> (m && (m.name <span class="gly">|</span><span class="gly">|</span> m.modelName)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> name = m.modelName <span class="gly">|</span><span class="gly">|</span> m.name;</code></li><li class="uncovered"><code>                    app.models<span class="gly">[</span>name<span class="gly">]</span> = m;</code></li><li class="uncovered"><code>                    global<span class="gly">[</span>name<span class="gly">]</span> = m;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>app.disconnectSchemas = <span class="kwrd">function</span> <span class="func">disconnectSchemas</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (_schemas.length) <span class="gly">{</span></code></li><li class=""><code>        _schemas.<span class="func">forEach</span>(<span class="kwrd">function</span> (schema) <span class="gly">{</span></code></li><li class="uncovered"><code>            schema.<span class="func">disconnect</span>();</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>        _schemas = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-controller-bridge-js" class="filename" name="lib-controller-bridge-js" onclick="var el = document.getElementById('lib-controller-bridge-js'); el.style.display = el.style.display ? '' : 'none';">lib/controller_bridge.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 40%"><strong>40%</strong> [15/48]</div></div></div></div><div id="lib-controller-bridge-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> ControllerBrigde = <span class="gly">{</span></code></li><li class=""><code>    config: <span class="gly">{</span></code></li><li class=""><code>        subdoma<span class="kwrd">in</span>: <span class="gly">{</span></code></li><li class=""><code>            tld: 2</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>ControllerBrigde.uniCaller = <span class="kwrd">function</span> (ns, controller, action, params) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> (req, res, next) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">var</span> subdoma<span class="kwrd">in</span> = req.headers.host</code></li><li class=""><code>            .<span class="func">split</span>(<span class="S">'.'</span>)</code></li><li class=""><code>            .<span class="func">slice</span>(0, -1 * ControllerBrigde.config.subdoma<span class="kwrd">in</span>.tld)</code></li><li class="uncovered"><code>        req.subdoma<span class="kwrd">in</span> = subdoma<span class="kwrd">in</span>.jo<span class="kwrd">in</span>(<span class="S">'.'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (params && params.subdoma<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.subdoma<span class="kwrd">in</span> !== req.subdoma<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (params.subdoma<span class="kwrd">in</span>.<span class="func">match</span>(<span class="R">/\*/</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> matched = true;</code></li><li class=""><code>                    params.subdoma<span class="kwrd">in</span>.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (part, i) <span class="gly">{</span></code></li><li class="uncovered"><code>                        <span class="kwrd">if</span> (part === <span class="S">'*'</span>) <span class="kwrd">return</span>;</code></li><li class="uncovered"><code>                        <span class="kwrd">if</span> (part !== subdoma<span class="kwrd">in</span><span class="gly">[</span>i<span class="gly">]</span>) matched = false;</code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>                    <span class="kwrd">if</span> (!matched) <span class="kwrd">return</span> <span class="func">next</span>(); <span class="C">// next route</span></code></li><li class="uncovered"><code>                <span class="gly">}</span> else <span class="kwrd">return</span> <span class="func">next</span>();</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ctl = ControllerBrigde.<span class="func">loadController</span>(ns + (controller <span class="gly">|</span><span class="gly">|</span> req.params.controller));</code></li><li class=""><code>        <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'model cache'</span>)) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// TODO: reloadModels should work without any params</span></code></li><li class=""><code>            <span class="C">// it just should remember all paths</span></code></li><li class=""><code>            <span class="C">// called previously with</span></code></li><li class="uncovered"><code>            app.<span class="func">reloadModels</span>(app.root + <span class="S">'/app/models/'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        ctl.<span class="func">perform</span>(action <span class="gly">|</span><span class="gly">|</span> req.params.action, req, res, next);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>ControllerBrigde.loadController = <span class="kwrd">function</span> (controller) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> railway.controller.<span class="func">load</span>(controller);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>module.exports = ControllerBrigde;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-logger-js" class="filename" name="lib-logger-js" onclick="var el = document.getElementById('lib-logger-js'); el.style.display = el.style.display ? '' : 'none';">lib/logger.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 100%"><strong>100%</strong> [7/15]</div></div></div></div><div id="lib-logger-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.stream = null;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>    exports.stream = app.settings.quiet ?</code></li><li class=""><code>        fs.<span class="func">createWriteStream</span>(path.jo<span class="kwrd">in</span>(app.root, <span class="S">'log'</span>, app.settings.env + <span class="S">'.log'</span>)) :</code></li><li class="covered"><code>        process.stdout;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.write = <span class="kwrd">function</span> (str) <span class="gly">{</span></code></li><li class="covered"><code>    (exports.stream <span class="gly">|</span><span class="gly">|</span> process.stdout).<span class="func">write</span>(str + <span class="S">'\n'</span>);</code><span class="hits">43</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li></ol></pre></div>
    </div>
  </body>
</html>
